<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LaTeX Онлайн-редактор</title>
  
  <!-- CodeMirror для редактора кода -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/default.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/stex/stex.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/anyword-hint.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.js"></script>
  
  <!-- Дополнительные аддоны CodeMirror для автодополнения -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchbrackets.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.min.js"></script>
  
  <!-- Firebase для совместной работы -->
  <script src="https://www.gstatic.com/firebasejs/9.20.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.20.0/firebase-database-compat.js"></script>
  
  <!-- MathJax для формул в подсказках и предпросмотре -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.0/es5/tex-mml-chtml.min.js"></script>
  
  <!-- Yjs и связанные библиотеки для совместной работы -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/y-codemirror/3.0.1/y-codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/y-websocket/1.5.0/y-websocket.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/yjs/13.5.52/y.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/y-protocols/1.0.5/y-protocols.min.js"></script>
  
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    header {
      background-color: #2c3e50;
      color: white;
      padding: 8px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    header h1 {
      font-size: 18px;
      font-weight: 500;
      margin: 0;
    }
    
    .header-buttons {
      display: flex;
      gap: 8px;
    }
    
    button {
      background-color: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 4px 10px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    
    button:hover {
      background-color: #3498db;
      color: white;
    }
    
    button.active {
      background-color: #3498db;
      color: white;
    }
    
    main {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    
    .editor-pane {
      flex: 1;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #ddd;
    }
    
    .preview-pane {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .toolbar {
      background-color: #f5f5f5;
      padding: 4px;
      border-bottom: 1px solid #ddd;
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }
    
    .editor-container {
      flex: 1;
      overflow: hidden;
      position: relative;
    }
    
    .CodeMirror {
      height: 100%;
      font-size: 14px;
    }
    
    .preview-container {
      flex: 1;
      overflow: auto;
      background-color: #f5f5f5;
      padding: 16px;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }
    
    #pdf-preview {
      background-color: white;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      padding: 40px;
      width: 210mm;
      min-height: 297mm;
      box-sizing: border-box;
      margin: 20px;
      transform-origin: top center;
    }
    
    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 100;
      display: none;
    }
    
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top: 4px solid #3498db;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .status-bar {
      background-color: #2c3e50;
      color: white;
      padding: 4px 12px;
      font-size: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 200;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.5);
    }
    
    .modal-content {
      background-color: white;
      margin: 10% auto;
      padding: 20px;
      border-radius: 5px;
      width: 50%;
      max-width: 500px;
    }
    
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .close:hover {
      color: black;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
    }
    
    input[type="text"], textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    .macro-list {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-top: 10px;
    }
    
    .macro-item {
      padding: 5px 10px;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .macro-item:last-child {
      border-bottom: none;
    }
    
    .macro-actions {
      display: flex;
      gap: 5px;
    }
    
    .formula-preview {
      margin-top: 10px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: white;
      text-align: center;
      min-height: 60px;
    }
    
    /* PDF стили */
    .pdf-title {
      font-size: 24px;
      text-align: center;
      margin-bottom: 20px;
    }
    
    .pdf-author {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .pdf-date {
      text-align: center;
      margin-bottom: 50px;
    }
    
    .pdf-section {
      font-size: 18px;
      font-weight: bold;
      margin-top: 20px;
      margin-bottom: 10px;
    }
    
    .pdf-subsection {
      font-size: 16px;
      font-weight: bold;
      margin-top: 15px;
      margin-bottom: 10px;
    }
    
    .pdf-paragraph {
      margin-bottom: 10px;
      text-align: justify;
    }
    
    .pdf-equation {
      margin: 15px 0;
      text-align: center;
    }
    
    .pdf-list {
      margin-left: 20px;
    }
    
    /* Стили для совместной работы */
    .collaboration-indicator {
      display: flex;
      align-items: center;
      margin-left: 10px;
    }
    
    .collaboration-status {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 5px;
    }
    
    .collaboration-status.active {
      background-color: #2ecc71;
    }
    
    .collaboration-status.inactive {
      background-color: #e74c3c;
    }
    
    .user-indicator {
      display: inline-block;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background-color: #3498db;
      color: white;
      text-align: center;
      line-height: 24px;
      font-size: 12px;
      margin-left: 5px;
    }
    
    .session-info {
      display: flex;
      align-items: center;
    }
    
    #session-id {
      font-family: monospace;
      margin-left: 5px;
    }
    
    #copy-session {
      margin-left: 5px;
      padding: 2px 5px;
      font-size: 12px;
    }
    
    .autosave-indicator, .autocompile-indicator {
      font-size: 12px;
      margin-left: 10px;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .autosave-indicator.show, .autocompile-indicator.show {
      opacity: 1;
    }
    
    /* Стили для управления файлами */
    .file-list {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-top: 10px;
    }
    
    .file-item {
      padding: 8px 12px;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }
    
    .file-item:hover {
      background-color: #f0f0f0;
    }
    
    .file-item.active {
      background-color: #e3f2fd;
      font-weight: bold;
    }
    
    .file-item:last-child {
      border-bottom: none;
    }
    
    .file-actions {
      display: flex;
      gap: 5px;
    }
    
    .settings-panel {
      background-color: #f5f5f5;
      padding: 10px;
      border-bottom: 1px solid #ddd;
    }
    
    .settings-row {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .settings-row:last-child {
      margin-bottom: 0;
    }
    
    .settings-row label {
      display: inline-block;
      margin-right: 8px;
      margin-bottom: 0;
    }
    
    .switch {
      position: relative;
      display: inline-block;
      width: 40px;
      height: 20px;
    }
    
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 20px;
    }
    
    .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .slider {
      background-color: #2196F3;
    }
    
    input:checked + .slider:before {
      transform: translateX(20px);
    }
    
    /* Макросы */
    .macro-sidebar {
      position: fixed;
      top: 60px;
      right: -300px;
      width: 300px;
      height: calc(100% - 60px);
      background-color: white;
      box-shadow: -2px 0 5px rgba(0, 0, 0, 0.1);
      z-index: 50;
      transition: right 0.3s;
      display: flex;
      flex-direction: column;
    }
    
    .macro-sidebar.open {
      right: 0;
    }
    
    .macro-sidebar-header {
      padding: 10px;
      background-color: #2c3e50;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .macro-sidebar-body {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }
    
    .macro-category {
      margin-bottom: 15px;
    }
    
    .macro-category-title {
      font-weight: bold;
      margin-bottom: 5px;
      padding-bottom: 3px;
      border-bottom: 1px solid #ddd;
    }
    
    .macro-quick-list {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 5px;
    }
    
    .macro-quick-item {
      padding: 3px 6px;
      background-color: #f0f0f0;
      border-radius: 3px;
      font-size: 12px;
      cursor: pointer;
    }
    
    .macro-quick-item:hover {
      background-color: #e0e0e0;
    }
    
    .macro-search {
      padding: 10px;
      border-bottom: 1px solid #ddd;
    }
    
    .macro-search input {
      width: 100%;
      padding: 6px;
      border: 1px solid #ddd;
      border-radius: 3px;
    }
    
    .hint-tooltip {
      position: absolute;
      background-color: #fff;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 8px;
      max-width: 300px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      z-index: 1000;
      font-size: 13px;
      display: none;
    }
    
    .commands-list {
      max-height: 300px;
      overflow-y: auto;
    }
    
    .command-item {
      padding: 8px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }
    
    .command-item:hover {
      background-color: #f5f5f5;
    }
    
    .command-name {
      font-weight: bold;
      color: #2c3e50;
    }
    
    .command-description {
      font-size: 12px;
      color: #666;
      margin-top: 2px;
    }
    
    .invite-link {
      display: block;
      padding: 8px;
      background-color: #f5f5f5;
      border-radius: 4px;
      margin-top: 10px;
      word-break: break-all;
      font-family: monospace;
    }
    
    .copy-btn {
      float: right;
      padding: 2px 5px;
      font-size: 12px;
      margin-left: 5px;
    }
    
    /* Стили для отображения удаленных курсоров */
    .remote-cursor {
      position: absolute;
      width: 2px;
      height: 16px;
      background-color: #f39c12;
      z-index: 10;
      pointer-events: none;
    }
    
    .remote-cursor::after {
      content: attr(data-name);
      position: absolute;
      top: -18px;
      left: 0;
      background-color: #f39c12;
      color: white;
      padding: 2px 4px;
      border-radius: 3px;
      font-size: 10px;
      white-space: nowrap;
    }
    
    .remote-selection {
      background-color: rgba(243, 156, 18, 0.2);
      position: absolute;
      z-index: 1;
      pointer-events: none;
    }
    
    .remote-user-badge {
      display: inline-flex;
      align-items: center;
      margin-right: 10px;
      margin-bottom: 5px;
    }
    
    .user-color {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 5px;
    }
    
    /* Адаптивный дизайн */
    @media (max-width: 768px) {
      main {
        flex-direction: column;
      }
      
      .editor-pane, .preview-pane {
        flex: 1 0 50%;
        border-right: none;
        border-bottom: 1px solid #ddd;
      }
      
      .modal-content {
        width: 90%;
      }
      
      .macro-sidebar {
        width: 80%;
        right: -80%;
      }
    }
  </style>
</head>
<body>
  <header>
    <div style="display: flex; align-items: center;">
      <h1>LaTeX Онлайн-редактор</h1>
      <div id="collaboration-indicator" class="collaboration-indicator">
        <span class="collaboration-status inactive"></span>
        <span id="collaboration-text">Офлайн режим</span>
      </div>
      <span id="autosave-indicator" class="autosave-indicator">Автосохранение...</span>
      <span id="autocompile-indicator" class="autocompile-indicator">Автокомпиляция...</span>
    </div>
    <div class="header-buttons">
      <button id="compile-btn">Компилировать</button>
      <button id="settings-btn">Настройки</button>
      <button id="files-btn">Файлы</button>
      <button id="manage-macros-btn">Макросы</button>
      <button id="toggle-collab-btn">Совместная работа</button>
      <button id="help-btn">Справка</button>
    </div>
  </header>
  
  <main>
    <div class="editor-pane">
      <div class="toolbar">
        <button data-insert="\section{}">Раздел</button>
        <button data-insert="\subsection{}">Подраздел</button>
        <button data-insert="\begin{equation}\n\n\end{equation}">Уравнение</button>
        <button data-insert="\begin{figure}\n\centering\n\includegraphics[width=0.8\textwidth]{}\n\caption{}\n\label{fig:}\n\end{figure}">Рисунок</button>
        <button data-insert="\begin{table}\n\centering\n\begin{tabular}{|c|c|}\n\hline\n & \\\\ \n\hline\n & \\\\ \n\hline\n\end{tabular}\n\caption{}\n\label{tab:}\n\end{table}">Таблица</button>
        <button data-insert="\begin{itemize}\n\item \n\item \n\end{itemize}">Список</button>
        <button data-insert="\begin{enumerate}\n\item \n\item \n\end{enumerate}">Нумер. список</button>
        <button data-insert="$$">Формула</button>
        <button id="toggle-macros-sidebar">Макросы »</button>
      </div>
      <div class="settings-panel" style="display: none;">
        <div class="settings-row">
          <label for="autosave-toggle">Автосохранение:</label>
          <label class="switch">
            <input type="checkbox" id="autosave-toggle" checked>
            <span class="slider"></span>
          </label>
        </div>
        <div class="settings-row">
          <label for="autocompile-toggle">Автокомпиляция:</label>
          <label class="switch">
            <input type="checkbox" id="autocompile-toggle">
            <span class="slider"></span>
          </label>
        </div>
        <div class="settings-row">
          <label for="autosave-interval">Интервал автосохранения (секунды):</label>
          <input type="number" id="autosave-interval" min="1" max="30" value="3" style="width: 50px;">
        </div>
        <div class="settings-row">
          <label for="autocompile-delay">Задержка автокомпиляции (секунды):</label>
          <input type="number" id="autocompile-delay" min="1" max="10" value="2" style="width: 50px;">
        </div>
      </div>
      <div class="editor-container">
        <textarea id="editor">
\documentclass{article}
\usepackage[utf8]{inputenc}
\usepackage[T2A]{fontenc}
\usepackage[russian]{babel}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{graphicx}
\usepackage{hyperref}

\title{Название документа}
\author{Ваше имя}
\date{\today}

\begin{document}

\maketitle

\section{Введение}
Напишите здесь ваш текст...

\section{Математические формулы}
Пример встроенной формулы: $E = mc^2$

Пример выделенной формулы:
\begin{equation}
F(x) = \int_{a}^{b} f(x) \, dx
\end{equation}

\section{Списки}
\begin{itemize}
  \item Первый пункт
  \item Второй пункт
  \item Третий пункт
\end{itemize}

\end{document}
        </textarea>
        <div class="loading-overlay">
          <div class="spinner"></div>
        </div>
        <div class="hint-tooltip" id="hint-tooltip"></div>
      </div>
      <div class="status-bar">
        <div style="display: flex; align-items: center;">
          <span id="status">Готово</span>
          <div id="session-info" class="session-info" style="display: none; margin-left: 10px;">
            Сессия: <span id="session-id"></span>
            <button id="copy-session">Копировать</button>
          </div>
        </div>
        <div style="display: flex; align-items: center;">
          <span id="current-file">Файл: document1.tex</span>
          <span id="cursor-position" style="margin-left: 15px;">Строка: 1, Столбец: 1</span>
        </div>
      </div>
    </div>
    
    <div class="preview-pane">
      <div class="toolbar">
        <button id="zoom-in">Увеличить</button>
        <button id="zoom-out">Уменьшить</button>
        <button id="download-pdf">Скачать PDF</button>
      </div>
      <div class="preview-container">
        <div id="pdf-preview">
          <!-- Здесь будет предпросмотр PDF -->
        </div>
      </div>
    </div>
  </main>
  
  <!-- Боковая панель макросов -->
  <div class="macro-sidebar" id="macro-sidebar">
    <div class="macro-sidebar-header">
      <h3 style="margin: 0;">Быстрые макросы</h3>
      <button id="close-macros-sidebar">&times;</button>
    </div>
    <div class="macro-search">
      <input type="text" id="macro-search-input" placeholder="Поиск макросов...">
    </div>
    <div class="macro-sidebar-body" id="macro-sidebar-content">
      <!-- Здесь будут категории макросов -->
    </div>
  </div>
  
  <!-- Модальное окно для управления макросами -->
  <div id="macros-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Управление макросами</h2>
      <div class="form-group">
        <label for="macro-name">Название макроса:</label>
        <input type="text" id="macro-name" placeholder="Например: theorem">
      </div>
      <div class="form-group">
        <label for="macro-category">Категория:</label>
        <select id="macro-category">
          <option value="math">Математика</option>
          <option value="structure">Структура</option>
          <option value="environments">Окружения</option>
          <option value="custom">Пользовательские</option>
        </select>
      </div>
      <div class="form-group">
        <label for="macro-content">Содержимое макроса:</label>
        <textarea id="macro-content" rows="5" placeholder="\begin{theorem}\n\n\end{theorem}"></textarea>
      </div>
      <div class="form-group">
        <div class="formula-preview" id="macro-preview">
          <!-- Здесь будет предпросмотр формулы -->
        </div>
      </div>
      <button id="add-macro-btn">Добавить макрос</button>
      
      <h3 style="margin-top: 20px;">Ваши макросы</h3>
      <div style="margin-bottom: 10px;">
        <input type="text" id="macro-filter" placeholder="Фильтр макросов..." style="width: 100%;">
      </div>
      <div class="macro-list" id="macro-list">
        <!-- Здесь будет список макросов -->
      </div>
    </div>
  </div>
  
  <!-- Модальное окно для управления файлами -->
  <div id="files-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Управление файлами</h2>
      <div class="form-group">
        <label for="new-file-name">Новый файл:</label>
        <div style="display: flex;">
          <input type="text" id="new-file-name" placeholder="Имя файла (например: document2)" style="flex: 1;">
          <button id="create-file-btn" style="margin-left: 10px;">Создать</button>
        </div>
      </div>
      
      <h3 style="margin-top: 20px;">Ваши файлы</h3>
      <div class="file-list" id="file-list">
        <!-- Здесь будет список файлов -->
      </div>
    </div>
  </div>
  
  <!-- Модальное окно для совместной работы -->
  <div id="collab-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Совместная работа</h2>
      
      <div class="form-group">
        <h3>Создать сессию</h3>
        <button id="create-session-btn" style="width: 100%;">Создать новую сессию</button>
        <div id="session-link-container" style="display: none; margin-top: 10px;">
          <p>Отправьте эту ссылку для совместной работы:</p>
          <div class="invite-link" id="invite-link">
            https://latex-editor.com/join?session=abc123
            <button class="copy-btn" id="copy-invite">Копировать</button>
          </div>
        </div>
      </div>
      
      <div class="form-group" style="margin-top: 20px;">
        <h3>Присоединиться к сессии</h3>
        <p>Вставьте ссылку или ID сессии:</p>
        <div style="display: flex;">
          <input type="text" id="join-session" placeholder="https://latex-editor.com/join?session=abc123 или abc123" style="flex: 1;">
          <button id="join-session-btn" style="margin-left: 10px;">Присоединиться</button>
        </div>
      </div>
      
      <div class="form-group" style="margin-top: 20px;">
        <label for="user-name">Ваше имя в сессии:</label>
        <input type="text" id="user-name" placeholder="Введите ваше имя">
      </div>
      
      <div class="form-group" style="margin-top: 20px;" id="active-users-container">
        <h3>Активные пользователи</h3>
        <div id="active-users" style="padding: 10px; background-color: #f5f5f5; border-radius: 4px;">
          <!-- Здесь будет список активных пользователей -->
          <p style="color: #666; font-style: italic;">Не подключено к сессии</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Модальное окно справки -->
  <div id="help-modal" class="modal">
    <div class="modal-content" style="max-width: 700px; width: 70%;">
      <span class="close">&times;</span>
      <h2>Справка по LaTeX</h2>
      
      <div style="margin-bottom: 15px;">
        <input type="text" id="command-search" placeholder="Поиск команд LaTeX..." style="width: 100%;">
      </div>
      
      <div class="commands-list" id="commands-list">
        <!-- Здесь будет список команд и их описаний -->
      </div>
    </div>
  </div>

  <script>
    // Дождемся загрузки всех ресурсов
    document.addEventListener('DOMContentLoaded', function() {
      // Глобальные переменные
      let editor;
      let isCollaborationActive = false;
      let firebaseApp = null;
      let firebaseDB = null;
      let currentSessionId = null;
      let lastSavedContent = '';
      let autoSaveTimer = null;
      let autoCompileTimer = null;
      let autoSaveDelay = 3000; // 3 секунды
      let autoCompileDelay = 2000; // 2 секунды
      let isTyping = false;
      let lastTypingTime = 0;
      let isInitialLoad = true;
      let currentFileName = 'document1.tex';
      let userColor = null;
      let userId = null;
      let userName = 'Пользователь';
      let remoteCursors = {};
      let lastCursorPosition = null;
      let ignoreNextChange = false;
      let yDoc = null;
      let yText = null;
      let yUndoManager = null;
      let provider = null;
      
      // Настройки Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyBxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
        authDomain: "latex-editor-xxxxx.firebaseapp.com",
        databaseURL: "https://latex-editor-xxxxx.firebaseio.com",
        projectId: "latex-editor-xxxxx",
        storageBucket: "latex-editor-xxxxx.appspot.com",
        messagingSenderId: "xxxxxxxxxxxx",
        appId: "1:xxxxxxxxxxxx:web:xxxxxxxxxxxxxxxxxxxx"
      };
      
      // Настройки
      let settings = {
        autoSaveEnabled: true,
        autoCompileEnabled: false,
        autoSaveInterval: 3, // в секундах
        autoCompileDelay: 2  // в секундах
      };
      
      // Загрузка настроек из localStorage
      if (localStorage.getItem('latex-editor-settings')) {
        try {
          settings = JSON.parse(localStorage.getItem('latex-editor-settings'));
          // Обновляем интерфейс настроек
          document.getElementById('autosave-toggle').checked = settings.autoSaveEnabled;
          document.getElementById('autocompile-toggle').checked = settings.autoCompileEnabled;
          document.getElementById('autosave-interval').value = settings.autoSaveInterval;
          document.getElementById('autocompile-delay').value = settings.autoCompileDelay;
          
          autoSaveDelay = settings.autoSaveInterval * 1000;
          autoCompileDelay = settings.autoCompileDelay * 1000;
        } catch (e) {
          console.error('Ошибка при загрузке настроек:', e);
        }
      }
      
      // Генерация случайного ID
      function generateId(length = 8) {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        let result = '';
        for (let i = 0; i < length; i++) {
          result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return result;
      }
      
      // Генерация случайного цвета для пользователя
      function generateRandomColor() {
        const colors = [
          '#3498db', // синий
          '#2ecc71', // зеленый
          '#e74c3c', // красный
          '#9b59b6', // фиолетовый
          '#f1c40f', // желтый
          '#e67e22', // оранжевый
          '#1abc9c', // бирюзовый
          '#34495e'  // темно-синий
        ];
        return colors[Math.floor(Math.random() * colors.length)];
      }
      
      // LaTeX команды для подсказок
      const latexCommands = [
        { name: '\\section{}', description: 'Создает новый раздел документа' },
        { name: '\\subsection{}', description: 'Создает подраздел документа' },
        { name: '\\begin{equation}', description: 'Начало окружения для выделенного уравнения' },
        { name: '\\end{equation}', description: 'Конец окружения для выделенного уравнения' },
        { name: '\\begin{itemize}', description: 'Начало ненумерованного списка' },
        { name: '\\end{itemize}', description: 'Конец ненумерованного списка' },
        { name: '\\begin{enumerate}', description: 'Начало нумерованного списка' },
        { name: '\\end{enumerate}', description: 'Конец нумерованного списка' },
        { name: '\\item', description: 'Элемент списка' },
        { name: '\\textbf{}', description: 'Жирный текст' },
        { name: '\\textit{}', description: 'Курсивный текст' },
        { name: '\\underline{}', description: 'Подчеркнутый текст' },
        { name: '\\emph{}', description: 'Выделенный текст (обычно курсивом)' },
        { name: '\\cite{}', description: 'Цитирование источника из библиографии' },
        { name: '\\footnote{}', description: 'Добавление сноски' },
        { name: '\\label{}', description: 'Метка для перекрестной ссылки' },
        { name: '\\ref{}', description: 'Ссылка на метку' },
        { name: '\\pageref{}', description: 'Ссылка на страницу с меткой' },
        { name: '\\usepackage{}', description: 'Подключение пакета' },
        { name: '\\includegraphics{}', description: 'Вставка изображения' },
        { name: '\\frac{}{}', description: 'Дробь (числитель/знаменатель)' },
        { name: '\\sqrt{}', description: 'Квадратный корень' },
        { name: '\\sum', description: 'Знак суммы' },
        { name: '\\int', description: 'Знак интеграла' },
        { name: '\\prod', description: 'Знак произведения' },
        { name: '\\lim', description: 'Предел' },
        { name: '\\alpha', description: 'Греческая буква альфа (α)' },
        { name: '\\beta', description: 'Греческая буква бета (β)' },
        { name: '\\gamma', description: 'Греческая буква гамма (γ)' },
        { name: '\\delta', description: 'Греческая буква дельта (δ)' },
        { name: '\\epsilon', description: 'Греческая буква эпсилон (ε)' },
        { name: '\\theta', description: 'Греческая буква тета (θ)' }
      ];
      
      // Предустановленные макросы
      const presetMacros = {
        math: {
          'frac': '\\frac{a}{b}',
          'sqrt': '\\sqrt{x}',
          'sum': '\\sum_{i=1}^{n} i',
          'int': '\\int_{a}^{b} f(x) \\, dx',
          'limit': '\\lim_{x \\to \\infty} f(x)',
          'matrix': '\\begin{pmatrix}\na & b \\\\\nc & d\n\\end{pmatrix}'
        },
        structure: {
          'chapter': '\\chapter{Название главы}',
          'section': '\\section{Название раздела}',
          'subsection': '\\subsection{Название подраздела}',
          'subsubsection': '\\subsubsection{Название подподраздела}',
          'paragraph': '\\paragraph{Название абзаца}',
          'label': '\\label{tag:name}'
        },
        environments: {
          'theorem': '\\begin{theorem}\n  Утверждение теоремы.\n\\end{theorem}',
          'proof': '\\begin{proof}\n  Доказательство.\n\\end{proof}',
          'figure': '\\begin{figure}[h]\n  \\centering\n  \\includegraphics[width=0.7\\textwidth]{filename}\n  \\caption{Подпись к рисунку}\n  \\label{fig:label}\n\\end{figure}',
          'table': '\\begin{table}[h]\n  \\centering\n  \\begin{tabular}{|c|c|}\n    \\hline\n    A & B \\\\\n    \\hline\n    C & D \\\\\n    \\hline\n  \\end{tabular}\n  \\caption{Подпись к таблице}\n  \\label{tab:label}\n\\end{table}',
          'align': '\\begin{align}\n  a &= b + c \\\\\n  &= d + e\n\\end{align}'
        },
        custom: {}
      };
      
      // Инициализация редактора CodeMirror с поддержкой автодополнения
      editor = CodeMirror.fromTextArea(document.getElementById('editor'), {
        mode: "stex",
        lineNumbers: true,
        lineWrapping: true,
        indentUnit: 2,
        tabSize: 2,
        autofocus: true,
        matchBrackets: true,
        autoCloseBrackets: true,
        extraKeys: {
          "Ctrl-Enter": function() { compileLatex(); },
          "Ctrl-Space": function(cm) { 
            showCommandHints(cm); 
          },
          "Tab": function(cm) {
            // Проверка для активации макроса
            const cursor = cm.getCursor();
            const line = cm.getLine(cursor.line);
            const textBeforeCursor = line.substring(0, cursor.ch);
            
            // Проверяем, есть ли макрос для введенного текста
            const macros = JSON.parse(localStorage.getItem('latex-macros') || '{}');
            let macroFound = false;
            
            for (const key in macros) {
              if (textBeforeCursor.endsWith(key)) {
                // Удаляем триггер и вставляем содержимое макроса
                const from = {
                  line: cursor.line,
                  ch: cursor.ch - key.length
                };
                cm.replaceRange(macros[key], from, cursor);
                macroFound = true;
                break;
              }
            }
            
            if (!macroFound) {
              // Если макрос не найден, вставляем обычный таб
              cm.replaceSelection("  ");
            }
          }
        }
      });
      
      // Функция для показа подсказок команд LaTeX
      function showCommandHints(cm) {
        const cursor = cm.getCursor();
        const line = cm.getLine(cursor.line);
        const textBeforeCursor = line.substring(0, cursor.ch);
        
        // Находим последний символ "\" перед курсором
        const lastBackslashPos = textBeforeCursor.lastIndexOf('\\');
        
        if (lastBackslashPos !== -1) {
          const partialCommand = textBeforeCursor.substring(lastBackslashPos);
          
          // Фильтруем команды, соответствующие частичному вводу
          const matchingCommands = latexCommands.filter(cmd => 
            cmd.name.toLowerCase().startsWith(partialCommand.toLowerCase())
          );
          
          if (matchingCommands.length > 0) {
            // Позиция для отображения подсказки
            const cursorCoords = cm.cursorCoords(true);
            const hintTooltip = document.getElementById('hint-tooltip');
            
            hintTooltip.innerHTML = '';
            matchingCommands.forEach((cmd, index) => {
              const cmdElement = document.createElement('div');
              cmdElement.classList.add('command-item');
              cmdElement.innerHTML = `
                <div class="command-name">${cmd.name}</div>
                <div class="command-description">${cmd.description}</div>
              `;
              
              // Вставка команды при клике
              cmdElement.addEventListener('click', function() {
                const from = {
                  line: cursor.line,
                  ch: lastBackslashPos
                };
                cm.replaceRange(cmd.name, from, cursor);
                hideHintTooltip();
              });
              
              hintTooltip.appendChild(cmdElement);
            });
            
            // Отображаем подсказку
            hintTooltip.style.display = 'block';
            hintTooltip.style.left = `${cursorCoords.left}px`;
            hintTooltip.style.top = `${cursorCoords.top + 20}px`;
            
            // Закрываем подсказку при любом клике или нажатии клавиши
            document.addEventListener('click', hideHintTooltip);
            cm.on('keydown', hideHintTooltip);
          }
        }
      }
      
      // Скрытие подсказки
      function hideHintTooltip() {
        const hintTooltip = document.getElementById('hint-tooltip');
        hintTooltip.style.display = 'none';
        document.removeEventListener('click', hideHintTooltip);
        editor.off('keydown', hideHintTooltip);
      }
      
      // Устанавливаем слушатели для редактора
      editor.on('keyup', function(cm, event) {
        // Показываем подсказки при вводе символа "\"
        if (event.key === '\\') {
          setTimeout(() => showCommandHints(cm), 100);
        }
      });
      
      // ===== УПРАВЛЕНИЕ ФАЙЛАМИ =====
      
      // Загрузка списка файлов
      function loadFilesList() {
        const fileList = document.getElementById('file-list');
        fileList.innerHTML = '';
        
        // Получаем список файлов из localStorage
        const fileKeys = Object.keys(localStorage).filter(key => key.startsWith('latex-document-'));
        
        // Если нет файлов, создаем первый файл
        if (fileKeys.length === 0) {
          localStorage.setItem('latex-document-document1', editor.getValue());
          fileKeys.push('latex-document-document1');
        }
        
        // Отображаем файлы в списке
        fileKeys.forEach(key => {
          const fileName = key.replace('latex-document-', '');
          const fileItem = document.createElement('div');
          fileItem.className = 'file-item';
          if (fileName === currentFileName) {
            fileItem.classList.add('active');
          }
          
          const fileTitle = document.createElement('span');
          fileTitle.textContent = fileName;
          
          const fileActions = document.createElement('div');
          fileActions.className = 'file-actions';
          
          const renameBtn = document.createElement('button');
          renameBtn.textContent = 'Переименовать';
          renameBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            const newName = prompt('Введите новое имя файла:', fileName);
            if (newName && newName.trim() && newName !== fileName) {
              // Сохраняем содержимое под новым именем
              localStorage.setItem(`latex-document-${newName}`, localStorage.getItem(key));
              // Удаляем старый файл
              localStorage.removeItem(key);
              
              // Если текущий файл был переименован, обновляем currentFileName
              if (fileName === currentFileName) {
                currentFileName = newName;
                document.getElementById('current-file').textContent = `Файл: ${newName}`;
              }
              
              // Обновляем список
              loadFilesList();
            }
          });
          
          const deleteBtn = document.createElement('button');
          deleteBtn.textContent = 'Удалить';
          deleteBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            if (confirm(`Вы уверены, что хотите удалить файл "${fileName}"?`)) {
              // Удаляем файл
              localStorage.removeItem(key);
              
              // Если удалили текущий файл, загружаем другой
              if (fileName === currentFileName) {
                // Получаем оставшиеся файлы
                const remainingFiles = Object.keys(localStorage).filter(k => k.startsWith('latex-document-'));
                if (remainingFiles.length > 0) {
                  // Загружаем первый оставшийся файл
                  const nextFileName = remainingFiles[0].replace('latex-document-', '');
                  loadFile(nextFileName);
                } else {
                  // Если файлов не осталось, создаем новый
                  currentFileName = 'document1';
                  document.getElementById('current-file').textContent = `Файл: ${currentFileName}`;
                  editor.setValue('\\documentclass{article}\n\\begin{document}\n\nНовый документ\n\n\\end{document}');
                  localStorage.setItem(`latex-document-${currentFileName}`, editor.getValue());
                }
              }
              
              // Обновляем список
              loadFilesList();
            }
          });
          
          fileActions.appendChild(renameBtn);
          fileActions.appendChild(deleteBtn);
          
          fileItem.appendChild(fileTitle);
          fileItem.appendChild(fileActions);
          
          // Обработка клика по файлу (загрузка)
          fileItem.addEventListener('click', function() {
            if (fileName !== currentFileName) {
              loadFile(fileName);
            }
          });
          
          fileList.appendChild(fileItem);
        });
      }
      
      // Загрузка файла
      function loadFile(fileName) {
        // Сохраняем текущий файл перед переключением
        if (currentFileName) {
          localStorage.setItem(`latex-document-${currentFileName}`, editor.getValue());
        }
        
        // Загружаем выбранный файл
        const fileContent = localStorage.getItem(`latex-document-${fileName}`);
        if (fileContent) {
          // Если включена совместная работа, обновляем контент через Yjs
          if (isCollaborationActive && yText) {
            yText.delete(0, yText.length);
            yText.insert(0, fileContent);
          } else {
            editor.setValue(fileContent);
          }
          
          currentFileName = fileName;
          document.getElementById('current-file').textContent = `Файл: ${fileName}`;
          
          // Обновляем lastSavedContent для правильной работы автосохранения
          lastSavedContent = fileContent;
          
          // Компилируем загруженный файл
          compileLatex();
        }
      }
      
      // Создание нового файла
      document.getElementById('create-file-btn').addEventListener('click', function() {
        const fileName = document.getElementById('new-file-name').value.trim();
        if (fileName) {
          // Проверяем, существует ли файл с таким именем
          if (localStorage.getItem(`latex-document-${fileName}`)) {
            alert(`Файл с именем "${fileName}" уже существует!`);
            return;
          }
          
          // Сохраняем текущий файл
          localStorage.setItem(`latex-document-${currentFileName}`, editor.getValue());
          
          // Создаем новый файл с шаблоном
          const templateContent = `\\documentclass{article}
\\usepackage[utf8]{inputenc}
\\usepackage[T2A]{fontenc}
\\usepackage[russian]{babel}
\\usepackage{amsmath}
\\usepackage{amsfonts}
\\usepackage{amssymb}
\\usepackage{graphicx}

\\title{${fileName}}
\\author{Автор}
\\date{\\today}

\\begin{document}

\\maketitle

\\section{Введение}
Содержимое нового документа.

\\end{document}`;
          
          localStorage.setItem(`latex-document-${fileName}`, templateContent);
          
          // Загружаем новый файл
          loadFile(fileName);
          
          // Сбрасываем поле ввода
          document.getElementById('new-file-name').value = '';
          
          // Обновляем список
          loadFilesList();
          
          // Закрываем модальное окно
          document.getElementById('files-modal').style.display = 'none';
        } else {
          alert('Введите имя файла!');
        }
      });
      
      // ===== АВТОСОХРАНЕНИЕ =====
      
      // Функция автосохранения
      function setupAutoSave() {
        // Отслеживаем изменения в редакторе
        editor.on("change", function(cm, changeObj) {
          // Пропускаем изменения, вызванные синхронизацией
          if (ignoreNextChange) {
            ignoreNextChange = false;
            return;
          }
          
          // Отметим, что пользователь печатает
          isTyping = true;
          lastTypingTime = Date.now();
          
          // Сбрасываем предыдущий таймер автосохранения
          if (autoSaveTimer) {
            clearTimeout(autoSaveTimer);
          }
          
          // Устанавливаем новый таймер для автосохранения
          if (settings.autoSaveEnabled) {
            autoSaveTimer = setTimeout(function() {
              // Проверяем, прошло ли достаточно времени с последнего ввода
              if (Date.now() - lastTypingTime >= autoSaveDelay) {
                isTyping = false;
                autoSave();
              }
            }, autoSaveDelay);
          }
          
          // Сбрасываем предыдущий таймер автокомпиляции
          if (autoCompileTimer) {
            clearTimeout(autoCompileTimer);
          }
          
          // Устанавливаем новый таймер для автокомпиляции
          if (settings.autoCompileEnabled) {
            autoCompileTimer = setTimeout(function() {
              // Показываем индикатор автокомпиляции
              const autocompileIndicator = document.getElementById('autocompile-indicator');
              autocompileIndicator.classList.add('show');
              
              compileLatex();
              
              // Скрываем индикатор через некоторое время
              setTimeout(function() {
                autocompileIndicator.classList.remove('show');
              }, 2000);
            }, autoCompileDelay);
          }
          
          // Отправляем позицию курсора, если включена совместная работа
          if (isCollaborationActive && firebaseDB && currentSessionId) {
            updateCursorPosition();
          }
        });
        
        // Также сохраняем при потере фокуса
        editor.on("blur", function() {
          if (isTyping && settings.autoSaveEnabled) {
            isTyping = false;
            autoSave();
          }
        });
        
        // Отслеживаем перемещение курсора для совместной работы
        editor.on("cursorActivity", function() {
          if (isCollaborationActive && firebaseDB && currentSessionId) {
            updateCursorPosition();
          }
        });
      }
      
      // Функция для выполнения автосохранения
      function autoSave() {
        const content = editor.getValue();
        
        // Проверяем, изменился ли контент с последнего сохранения
        if (content !== lastSavedContent) {
          // Показываем индикатор автосохранения
          const autosaveIndicator = document.getElementById('autosave-indicator');
          autosaveIndicator.classList.add('show');
          
          // Сохраняем локально
          localStorage.setItem(`latex-document-${currentFileName}`, content);
          lastSavedContent = content;
          
          // Если активна совместная работа, синхронизируем с Firebase
          // (но это делается автоматически через Yjs)
          
          // Обновляем статус
          document.getElementById('status').textContent = "Автосохранение...";
          
          // Скрываем индикатор автосохранения через некоторое время
          setTimeout(function() {
            autosaveIndicator.classList.remove('show');
            document.getElementById('status').textContent = "Готово";
          }, 2000);
        }
      }
      
      // ===== СОВМЕСТНАЯ РАБОТА =====
      
      // Инициализация Firebase
      function initFirebase() {
        try {
          // Инициализируем Firebase, если еще не инициализирован
          if (!firebaseApp) {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            firebaseDB = firebase.database();
          }
          
          // Изменяем индикатор
          document.querySelector('.collaboration-status').classList.remove('inactive');
          document.querySelector('.collaboration-status').classList.add('active');
          document.getElementById('collaboration-text').textContent = "Сессия активна";
          
          return true;
        } catch (error) {
          console.error("Ошибка инициализации Firebase:", error);
          alert("Ошибка при запуске совместной работы. Проверьте подключение к интернету и обновите страницу.");
          return false;
        }
      }
      
      // Инициализация Yjs для совместной работы
      function initYjs(sessionId) {
        try {
          // Создаем новый Yjs документ
          yDoc = new Y.Doc();
          
          // Создаем общий текстовый тип для редактора
          yText = yDoc.getText('codemirror');
          
          // Создаем менеджер отмены операций
          yUndoManager = new Y.UndoManager(yText);
          
          // Настраиваем связь редактора CodeMirror и Yjs
          const yBinding = new window.CodemirrorBinding(yText, editor, userId);
          
          // Настраиваем провайдера для синхронизации с Firebase
          provider = new window.YWebsocket(`wss://webrtc-signaling.example.com/${sessionId}`);
          
          // В случае ошибки с WebSocket, можно использовать IndexedDB для локального хранения
          const indexeddbProvider = new window.Y.IndexeddbPersistence(sessionId, yDoc);
          
          // Слушаем событие синхронизации
          provider.on('sync', () => {
            console.log('Синхронизация Yjs успешно завершена');
          });
          
          // Обработка подключений других пользователей
          provider.awareness.on('change', () => {
            updateUsersList();
          });
          
          // Обновляем информацию о себе в awareness
          provider.awareness.setLocalStateField('user', {
            name: userName,
            color: userColor,
            id: userId
          });
          
          return true;
        } catch (error) {
          console.error("Ошибка инициализации Yjs:", error);
          alert("Ошибка при настройке совместной работы. Пожалуйста, обновите страницу и попробуйте снова.");
          return false;
        }
      }
      
      // Функция для обновления списка пользователей
      function updateUsersList() {
        if (!provider || !provider.awareness) return;
        
        const usersContainer = document.getElementById('active-users');
        usersContainer.innerHTML = '';
        
        // Получаем список всех пользователей из awareness
        const states = provider.awareness.getStates();
        const activeUsers = [];
        
        states.forEach((state, clientId) => {
          if (state.user) {
            activeUsers.push({
              id: state.user.id || clientId.toString(),
              name: state.user.name || 'Гость',
              color: state.user.color || '#cccccc',
              isCurrentUser: state.user.id === userId
            });
          }
        });
        
        // Отображаем пользователей
        activeUsers.forEach(user => {
          const userEl = document.createElement('div');
          userEl.className = 'remote-user-badge';
          userEl.innerHTML = `
            <span class="user-color" style="background-color: ${user.color}"></span>
            <span>${user.name} ${user.isCurrentUser ? '(Вы)' : ''}</span>
          `;
          usersContainer.appendChild(userEl);
        });
        
        if (activeUsers.length === 0) {
          usersContainer.innerHTML = '<p style="color: #666; font-style: italic;">Не подключено к сессии</p>';
        }
      }
      
      // Создание новой сессии
      function createSession() {
        if (!initFirebase()) return;
        
        // Генерируем уникальный ID для сессии
        const sessionId = generateId(12);
        
        // Генерируем уникальный ID пользователя и цвет
        userId = generateId(8);
        userColor = generateRandomColor();
        userName = document.getElementById('user-name').value || 'Пользователь';
        
        // Устанавливаем текущую сессию
        currentSessionId = sessionId;
        
        // Инициализируем Yjs
        if (!initYjs(sessionId)) return;
        
        // Создаем запись в Firebase о новой сессии
        firebaseDB.ref('sessions/' + sessionId).set({
          createdAt: firebase.database.ServerValue.TIMESTAMP,
          createdBy: userId,
          users: {
            [userId]: {
              name: userName,
              color: userColor,
              online: true,
              lastActive: firebase.database.ServerValue.TIMESTAMP
            }
          },
          files: {
            [currentFileName]: {
              lastModified: firebase.database.ServerValue.TIMESTAMP
            }
          }
        });
        
        // Загружаем содержимое текущего документа в Yjs
        const content = editor.getValue();
        yText.delete(0, yText.length);
        yText.insert(0, content);
        
        // Обновляем интерфейс
        document.getElementById('session-id').textContent = sessionId;
        document.getElementById('session-info').style.display = 'flex';
        
        // Формируем ссылку для приглашения
        const inviteLink = `${window.location.origin}${window.location.pathname}?session=${sessionId}`;
        document.getElementById('invite-link').innerHTML = inviteLink + 
          '<button class="copy-btn" id="copy-invite">Копировать</button>';
        document.getElementById('session-link-container').style.display = 'block';
        
        // Обработчик для кнопки копирования
        document.getElementById('copy-invite').addEventListener('click', function() {
          navigator.clipboard.writeText(inviteLink).then(function() {
            alert("Ссылка скопирована в буфер обмена");
          }, function(err) {
            console.error('Не удалось скопировать ссылку: ', err);
          });
        });
        
        // Активируем режим совместной работы
        isCollaborationActive = true;
        
        // Обновляем список пользователей
        updateUsersList();
        
        // Закрываем модальное окно
        document.getElementById('collab-modal').style.display = 'none';
        
        return sessionId;
      }
      
      // Присоединение к существующей сессии
      function joinSession(sessionId) {
        if (!initFirebase()) return;
        
        // Извлекаем ID сессии из ссылки, если она была вставлена
        if (sessionId.includes('?session=')) {
          sessionId = sessionId.split('?session=')[1];
        }
        
        // Проверяем существование сессии
        firebaseDB.ref('sessions/' + sessionId).once('value', snapshot => {
          if (snapshot.exists()) {
            // Генерируем уникальный ID пользователя и цвет
            userId = generateId(8);
            userColor = generateRandomColor();
            userName = document.getElementById('user-name').value || 'Гость';
            
            // Устанавливаем текущую сессию
            currentSessionId = sessionId;
            
            // Инициализируем Yjs
            if (!initYjs(sessionId)) return;
            
            // Добавляем себя в список пользователей сессии
            firebaseDB.ref('sessions/' + sessionId + '/users/' + userId).set({
              name: userName,
              color: userColor,
              online: true,
              lastActive: firebase.database.ServerValue.TIMESTAMP
            });
            
            // Обновляем интерфейс
            document.getElementById('session-id').textContent = sessionId;
            document.getElementById('session-info').style.display = 'flex';
            
            // Активируем режим совместной работы
            isCollaborationActive = true;
            
            // Обновляем список пользователей
            updateUsersList();
            
            // Настраиваем отслеживание курсоров
            setupCursorTracking();
            
            // Закрываем модальное окно
            document.getElementById('collab-modal').style.display = 'none';
            
            // Уведомляем об успешном присоединении
            alert(`Вы присоединились к сессии: ${sessionId}`);
          } else {
            alert(`Сессия ${sessionId} не существует или больше не активна`);
          }
        }).catch(error => {
          console.error("Ошибка при присоединении к сессии:", error);
          alert("Не удалось присоединиться к сессии. Проверьте ID сессии и подключение к интернету.");
        });
      }
      
      // Настройка отслеживания курсоров
      function setupCursorTracking() {
        if (!isCollaborationActive || !firebaseDB || !currentSessionId) return;
        
        // Отслеживаем изменения курсоров других пользователей
        firebaseDB.ref('sessions/' + currentSessionId + '/cursors').on('value', snapshot => {
          if (!snapshot.exists()) return;
          
          // Удаляем все существующие удаленные курсоры
          document.querySelectorAll('.remote-cursor, .remote-selection').forEach(el => el.remove());
          
          // Создаем новые курсоры и выделения
          const cursors = snapshot.val();
          for (const remoteUserId in cursors) {
            // Пропускаем свой курсор
            if (remoteUserId === userId) continue;
            
            const cursorData = cursors[remoteUserId];
            
            // Создаем индикатор курсора
            if (cursorData.position) {
              createRemoteCursor(remoteUserId, cursorData.position, cursorData.user);
            }
            
            // Создаем индикатор выделения
            if (cursorData.selection) {
              createRemoteSelection(remoteUserId, cursorData.selection, cursorData.user);
            }
          }
        });
      }
      
      // Создание индикатора удаленного курсора
      function createRemoteCursor(userId, position, userData) {
        if (!position) return;
        
        const cursorPos = editor.posFromIndex(position);
        const cursorCoords = editor.cursorCoords(cursorPos);
        
        const cursorElement = document.createElement('div');
        cursorElement.className = 'remote-cursor';
        cursorElement.id = `cursor-${userId}`;
        cursorElement.style.backgroundColor = userData.color || '#f39c12';
        cursorElement.dataset.name = userData.name || 'Гость';
        
        cursorElement.style.top = `${cursorCoords.top}px`;
        cursorElement.style.left = `${cursorCoords.left}px`;
        
        document.querySelector('.CodeMirror').appendChild(cursorElement);
      }
      
      // Создание индикатора удаленного выделения
      function createRemoteSelection(userId, selection, userData) {
        if (!selection || !selection.from || !selection.to) return;
        
        const from = editor.posFromIndex(selection.from);
        const to = editor.posFromIndex(selection.to);
        
        const selectionMarker = editor.markText(from, to, {
          css: `background-color: ${userData.color || '#f39c12'}33`,
          className: 'remote-selection',
          title: `${userData.name || 'Гость'} выделил этот текст`
        });
      }
      
      // Обновление позиции курсора
      function updateCursorPosition() {
        if (!isCollaborationActive || !firebaseDB || !currentSessionId || !userId) return;
        
        const cursor = editor.getCursor();
        const selection = editor.getSelection();
        const cursorIndex = editor.indexFromPos(cursor);
        
        let selectionData = null;
        if (selection && selection.length > 0) {
          const ranges = editor.listSelections();
          if (ranges.length > 0) {
            const range = ranges[0];
            selectionData = {
              from: editor.indexFromPos(range.anchor),
              to: editor.indexFromPos(range.head)
            };
          }
        }
        
        // Проверяем, изменилась ли позиция с последнего обновления
        const currentPosition = JSON.stringify({ cursor: cursorIndex, selection: selectionData });
        if (lastCursorPosition === currentPosition) return;
        
        lastCursorPosition = currentPosition;
        
        // Обновляем информацию о курсоре в Firebase
        firebaseDB.ref('sessions/' + currentSessionId + '/cursors/' + userId).set({
          position: cursorIndex,
          selection: selectionData,
          timestamp: firebase.database.ServerValue.TIMESTAMP,
          user: {
            name: userName,
            color: userColor
          }
        });
      }
      
      // Выход из сессии совместной работы
      function leaveSession() {
        if (!isCollaborationActive || !firebaseDB || !currentSessionId || !userId) return;
        
        // Обновляем статус в Firebase
        firebaseDB.ref('sessions/' + currentSessionId + '/users/' + userId).update({
          online: false,
          lastActive: firebase.database.ServerValue.TIMESTAMP
        });
        
        // Удаляем информацию о курсоре
        firebaseDB.ref('sessions/' + currentSessionId + '/cursors/' + userId).remove();
        
        // Отключаем провайдеры Yjs
        if (provider) {
          provider.disconnect();
          provider = null;
        }
        
        // Сбрасываем переменные сессии
        currentSessionId = null;
        isCollaborationActive = false;
        
        // Обновляем интерфейс
        document.querySelector('.collaboration-status').classList.remove('active');
        document.querySelector('.collaboration-status').classList.add('inactive');
        document.getElementById('collaboration-text').textContent = "Офлайн режим";
        document.getElementById('session-info').style.display = 'none';
        
        // Уведомляем пользователя
        alert("Вы вышли из сессии совместной работы");
      }
      
      // Настройка слушателей для совместной работы
      function setupCollaboration() {
        // Кнопка для открытия модального окна совместной работы
        document.getElementById('toggle-collab-btn').addEventListener('click', function() {
          // Если уже в сессии, предлагаем выйти
          if (isCollaborationActive) {
            if (confirm("Вы уже в сессии совместной работы. Хотите выйти из нее?")) {
              leaveSession();
            }
            return;
          }
          
          document.getElementById('collab-modal').style.display = 'block';
        });
        
        // Закрытие модального окна
        document.querySelectorAll('#collab-modal .close').forEach(function(closeBtn) {
          closeBtn.addEventListener('click', function() {
            document.getElementById('collab-modal').style.display = 'none';
          });
        });
        
        // Создание новой сессии
        document.getElementById('create-session-btn').addEventListener('click', function() {
          createSession();
        });
        
        // Присоединение к существующей сессии
        document.getElementById('join-session-btn').addEventListener('click', function() {
          const sessionId = document.getElementById('join-session').value.trim();
          if (sessionId) {
            joinSession(sessionId);
          } else {
            alert("Введите ID сессии!");
          }
        });
        
        // Копирование ID сессии
        document.getElementById('copy-session').addEventListener('click', function() {
          const sessionId = document.getElementById('session-id').textContent;
          navigator.clipboard.writeText(sessionId).then(function() {
            alert("ID сессии скопирован в буфер обмена");
          }, function(err) {
            console.error('Не удалось скопировать ID: ', err);
            alert("Не удалось скопировать ID. Попробуйте выделить и скопировать вручную.");
          });
        });
        
        // Проверка URL параметров при загрузке для автоматического присоединения к сессии
        window.addEventListener('load', function() {
          const urlParams = new URLSearchParams(window.location.search);
          const sessionParam = urlParams.get('session');
          
          if (sessionParam) {
            // Отображаем модальное окно для ввода имени
            document.getElementById('collab-modal').style.display = 'block';
            document.getElementById('join-session').value = sessionParam;
            
            // Фокусируемся на поле ввода имени
            document.getElementById('user-name').focus();
            
            // Меняем надпись для пользователя
            const joinText = document.querySelector('#collab-modal .form-group:nth-child(2) p');
            if (joinText) {
              joinText.innerHTML = '<strong>Обнаружена ссылка на сессию!</strong> Введите ваше имя и нажмите "Присоединиться"';
            }
          }
        });
        
        // Обработка событий до выгрузки страницы
        window.addEventListener('beforeunload', function() {
          if (isCollaborationActive) {
            leaveSession();
          }
        });
      }
      
      // ===== ОСНОВНЫЕ ФУНКЦИИ РЕДАКТОРА =====
      
      // Обновление позиции курсора
      editor.on("cursorActivity", function() {
        const cursor = editor.getCursor();
        document.getElementById('cursor-position').textContent = `Строка: ${cursor.line + 1}, Столбец: ${cursor.ch + 1}`;
      });
      
      // Кнопка компиляции
      document.getElementById('compile-btn').addEventListener('click', compileLatex);
      
      // Функция компиляции LaTeX
      function compileLatex() {
        const latexCode = editor.getValue();
        
        // Показываем индикатор загрузки
        const loadingOverlay = window.document.querySelector('.loading-overlay');
        const statusElement = window.document.getElementById('status');
        
        if (loadingOverlay) {
          loadingOverlay.style.display = 'flex';
        }
        
        if (statusElement) {
          statusElement.textContent = "Компиляция...";
        }
        
        // Имитация процесса компиляции с задержкой (для демонстрации)
        setTimeout(() => {
          try {
            // Парсинг LaTeX кода
            const parsedDocument = parseLatexDocument(latexCode);
            
            // Обновляем предпросмотр
            renderPdfPreview(parsedDocument);
            
            if (statusElement) {
              statusElement.textContent = "Компиляция завершена";
            }
            
          } catch (error) {
            console.error("Ошибка компиляции:", error);
            if (statusElement) {
              statusElement.textContent = "Ошибка компиляции: " + error.message;
            }
          } finally {
            if (loadingOverlay) {
              loadingOverlay.style.display = 'none';
            }
          }
        }, 800);
      }
      
      // Функция для парсинга LaTeX документа
      function parseLatexDocument(latexCode) {
        const document = {};
        
        // Извлечение заголовка
        const titleMatch = latexCode.match(/\\title\{([^}]*)\}/);
        document.title = titleMatch ? titleMatch[1] : "Без названия";
        
        // Извлечение автора
        const authorMatch = latexCode.match(/\\author\{([^}]*)\}/);
        document.author = authorMatch ? authorMatch[1] : "";
        
        // Извлечение даты
        const dateMatch = latexCode.match(/\\date\{([^}]*)\}/);
        document.date = dateMatch ? dateMatch[1] : "\\today";
        if (document.date === "\\today") {
          const today = new Date();
          document.date = today.toLocaleDateString('ru-RU');
        }
        
        // Извлечение содержимого документа
        const bodyMatch = latexCode.match(/\\begin\{document\}([\s\S]*)\\end\{document\}/);
        document.body = bodyMatch ? bodyMatch[1] : "";
        
        // Извлечение секций
        document.sections = [];
        const sectionRegex = /\\section\{([^}]*)\}([\s\S]*?)(?=\\section\{|\\end\{document\})/g;
        let sectionMatch;
        while ((sectionMatch = sectionRegex.exec(latexCode)) !== null) {
          document.sections.push({
            title: sectionMatch[1],
            content: sectionMatch[2]
          });
        }
        
        return document;
      }
      
      // Функция для рендеринга предпросмотра PDF
      function renderPdfPreview(docData) {
        const preview = window.document.getElementById('pdf-preview');
        
        if (!preview) {
          console.error('Элемент pdf-preview не найден');
          return;
        }
        
        // Создаем HTML-структуру для предпросмотра
        let html = `
          <div class="pdf-title">${docData.title}</div>
          <div class="pdf-author">${docData.author}</div>
          <div class="pdf-date">${docData.date}</div>
        `;
        
        // Обрабатываем содержимое секций
        if (docData.sections && docData.sections.length > 0) {
          docData.sections.forEach(section => {
            html += `<div class="pdf-section">${section.title}</div>`;
            
            // Заменяем LaTeX-команды на HTML
            let content = section.content;
            
            // Обработка списков itemize
            content = content.replace(/\\begin\{itemize\}([\s\S]*?)\\end\{itemize\}/g, function(match, listContent) {
              let listHTML = '<ul class="pdf-list">';
              const itemRegex = /\\item\s+(.*?)(?=\\item|$)/gs;
              let itemMatch;
              while ((itemMatch = itemRegex.exec(listContent)) !== null) {
                listHTML += `<li>${itemMatch[1].trim()}</li>`;
              }
              listHTML += '</ul>';
              return listHTML;
            });
            
            // Обработка списков enumerate
            content = content.replace(/\\begin\{enumerate\}([\s\S]*?)\\end\{enumerate\}/g, function(match, listContent) {
              let listHTML = '<ol class="pdf-list">';
              const itemRegex = /\\item\s+(.*?)(?=\\item|$)/gs;
              let itemMatch;
              while ((itemMatch = itemRegex.exec(listContent)) !== null) {
                listHTML += `<li>${itemMatch[1].trim()}</li>`;
              }
              listHTML += '</ol>';
              return listHTML;
            });
            
            // Обработка уравнений
            content = content.replace(/\\begin\{equation\}([\s\S]*?)\\end\{equation\}/g, 
              '<div class="pdf-equation">$$1</div>');
            
            // Обработка встроенных формул
            content = content.replace(/\$(.*?)\$/g, '\\($1\\)');
            
            // Разбиваем текст на абзацы
            const paragraphs = content.split('\n\n');
            paragraphs.forEach(paragraph => {
              if (paragraph.trim() && !paragraph.includes('<ul') && !paragraph.includes('<ol') && !paragraph.includes('pdf-equation')) {
                html += `<div class="pdf-paragraph">${paragraph.trim()}</div>`;
              } else {
                html += paragraph;
              }
            });
          });
        } else {
          // Если секции не найдены, отображаем основное содержимое
          html += `<div class="pdf-paragraph">${docData.body.trim()}</div>`;
        }
        
        preview.innerHTML = html;
        
        // Запускаем MathJax для рендеринга формул
        if (typeof MathJax !== 'undefined') {
          MathJax.typesetPromise([preview]).catch(function (err) {
            console.error('MathJax ошибка:', err);
          });
        }
      }
      
      // Вставка шаблонов из кнопок панели инструментов
      document.querySelectorAll('.toolbar button[data-insert]').forEach(button => {
        button.addEventListener('click', function() {
          const template = this.getAttribute('data-insert');
          const cursor = editor.getCursor();
          editor.replaceRange(template, cursor);
          
          // Устанавливаем курсор внутри вставленного шаблона
          if (template.includes('{}')) {
            const newPosition = {
              line: cursor.line,
              ch: cursor.ch + template.indexOf('{}') + 1
            };
            editor.setCursor(newPosition);
          } else if (template.includes('\n')) {
            const lines = template.split('\n');
            const newPosition = {
              line: cursor.line + 1,
              ch: lines[1].length
            };
            editor.setCursor(newPosition);
          }
          
          editor.focus();
        });
      });
      
      // Управление масштабом
      let scale = 1.0;
      
      document.getElementById('zoom-in').addEventListener('click', function() {
        scale += 0.1;
        updateZoom();
      });
      
      document.getElementById('zoom-out').addEventListener('click', function() {
        if (scale > 0.5) {
          scale -= 0.1;
          updateZoom();
        }
      });
      
      function updateZoom() {
        const preview = document.getElementById('pdf-preview');
        preview.style.transform = `scale(${scale})`;
      }
      
      // ===== УПРАВЛЕНИЕ МАКРОСАМИ =====
      
      // Функция инициализации макросов
      function initMacros() {
        // Загружаем пользовательские макросы из localStorage
        let userMacros = JSON.parse(localStorage.getItem('latex-macros') || '{}');
        
        // Объединяем предустановленные макросы и пользовательские
        const allMacros = JSON.parse(JSON.stringify(presetMacros));
        
        // Добавляем пользовательские макросы в категорию custom
        for (const key in userMacros) {
          allMacros.custom[key] = userMacros[key];
        }
        
        // Сохраняем обновленные макросы
        localStorage.setItem('latex-macros', JSON.stringify(userMacros));
        
        return allMacros;
      }
      
      // Отображение списка макросов в боковой панели
      function renderMacrosSidebar() {
        const allMacros = initMacros();
        const sidebarContent = document.getElementById('macro-sidebar-content');
        sidebarContent.innerHTML = '';
        
        // Отображаем каждую категорию
        for (const category in allMacros) {
          const categoryMacros = allMacros[category];
          
          if (Object.keys(categoryMacros).length > 0) {
            const categoryEl = document.createElement('div');
            categoryEl.className = 'macro-category';
            
            const categoryTitle = document.createElement('div');
            categoryTitle.className = 'macro-category-title';
            categoryTitle.textContent = getCategoryName(category);
            
            const macrosList = document.createElement('div');
            macrosList.className = 'macro-quick-list';
            
            for (const macroName in categoryMacros) {
              const macroContent = categoryMacros[macroName];
              
              const macroItem = document.createElement('div');
              macroItem.className = 'macro-quick-item';
              macroItem.textContent = macroName;
              macroItem.title = 'Нажмите, чтобы вставить';
              
              // Вставка макроса при клике
              macroItem.addEventListener('click', function() {
                editor.replaceSelection(macroContent);
                editor.focus();
              });
              
              macrosList.appendChild(macroItem);
            }
            
            categoryEl.appendChild(categoryTitle);
            categoryEl.appendChild(macrosList);
            sidebarContent.appendChild(categoryEl);
          }
        }
      }
      
      // Получение названия категории на русском
      function getCategoryName(category) {
        const names = {
          'math': 'Математика',
          'structure': 'Структура документа',
          'environments': 'Окружения',
          'custom': 'Пользовательские макросы'
        };
        return names[category] || category;
      }
      
      // Отображение списка макросов в модальном окне
      function renderMacrosList() {
        const macrosData = initMacros();
        const userMacros = JSON.parse(localStorage.getItem('latex-macros') || '{}');
        const macroList = document.getElementById('macro-list');
        const filter = document.getElementById('macro-filter').value.toLowerCase();
        
        macroList.innerHTML = '';
        
        // Создаем объединенный список макросов для отображения
        const displayMacros = {};
