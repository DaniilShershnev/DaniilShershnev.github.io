<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LaTeX Онлайн-редактор</title>
  
  <!-- CodeMirror для редактора кода -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/default.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/stex/stex.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchbrackets.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.min.js"></script>
  
  <!-- MathJax для формул в подсказках и предпросмотре -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.0/es5/tex-mml-chtml.min.js"></script>
  
  <!-- Подключаем наши стили и скрипты -->
  <link rel="stylesheet" href="css/styles.css">
  
  <style>
    /* Встраиваем основные стили для редактора рисования, чтобы гарантировать их загрузку */
    /* Модальное окно редактора рисования */
    .drawing-modal-content {
      width: 80%;
      max-width: 900px;
      height: 80vh;
      max-height: 700px;
      display: flex;
      flex-direction: column;
    }

    /* Панель инструментов */
    .drawing-toolbar {
      display: flex;
      padding: 10px;
      border-bottom: 1px solid #ddd;
      background-color: #f5f5f5;
      flex-wrap: wrap;
      gap: 10px;
    }

    /* Группы инструментов */
    .drawing-tools-group {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
      padding-right: 15px;
      border-right: 1px solid #ddd;
    }

    .drawing-settings-group {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
      padding-left: 15px;
    }

    /* Кнопки инструментов */
    .drawing-tool {
      width: 40px;
      height: 40px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 5px;
    }

    /* Контейнер для canvas */
    .drawing-canvas-container {
      flex: 1;
      overflow: hidden;
      position: relative;
      background-color: #f8f8f8;
      border: 1px solid #ddd;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <header>
    <div style="display: flex; align-items: center;">
      <h1>LaTeX Онлайн-редактор</h1>
      <span id="autosave-indicator" class="autosave-indicator">Автосохранение...</span>
    </div>
    <div class="header-buttons">
      <button id="compile-btn">Компилировать</button>
      <button id="settings-btn">Настройки</button>
      <button id="files-btn">Файлы</button>
      <button id="smart-macros-btn">Умные макросы</button>
      <button id="help-btn">Справка</button>
    </div>
  </header>
  
  <main>
    <div class="editor-pane">
      <div class="toolbar">
        <button data-insert="\section{}">Раздел</button>
        <button data-insert="\subsection{}">Подраздел</button>
        <button data-insert="\begin{equation}\n\n\end{equation}">Уравнение</button>
        <button data-insert="\begin{figure}\n\centering\n\includegraphics[width=0.8\textwidth]{}\n\caption{}\n\label{fig:}\n\end{figure}">Рисунок</button>
        <button id="drawing-btn" title="Редактор рисования">Нарисовать</button>
        <button data-insert="\begin{table}\n\centering\n\begin{tabular}{|c|c|}\n\hline\n & \\\\ \n\hline\n & \\\\ \n\hline\n\end{tabular}\n\caption{}\n\label{tab:}\n\end{table}">Таблица</button>
        <button data-insert="\begin{itemize}\n\item \n\item \n\end{itemize}">Список</button>
        <button data-insert="\begin{enumerate}\n\item \n\item \n\end{enumerate}">Нумер. список</button>
        <button data-insert="$$">Формула</button>
      </div>
      <div class="editor-container">
        <textarea id="editor">
\documentclass{article}
\usepackage[utf8]{inputenc}
\usepackage[T2A]{fontenc}
\usepackage[russian]{babel}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{graphicx}
\usepackage{hyperref}

\title{Название документа}
\author{Ваше имя}
\date{\today}

\begin{document}

\maketitle

\section{Введение}
Напишите здесь ваш текст...

\section{Математические формулы}
Пример встроенной формулы: $E = mc^2$

Пример выделенной формулы:
\begin{equation}
F(x) = \int_{a}^{b} f(x) \, dx
\end{equation}

\section{Списки}
\begin{itemize}
  \item Первый пункт
  \item Второй пункт
  \item Третий пункт
\end{itemize}

\end{document}
        </textarea>
        <div class="loading-overlay">
          <div class="spinner"></div>
        </div>
      </div>
      <div class="status-bar">
        <div>
          <span id="status">Готово</span>
        </div>
        <div style="display: flex; align-items: center;">
          <span id="current-file">document1.tex</span>
          <span id="cursor-position" style="margin-left: 15px;">Строка: 1, Столбец: 1</span>
        </div>
      </div>
    </div>
    
    <div class="preview-pane">
      <div class="toolbar">
        <button id="zoom-in">Увеличить</button>
        <button id="zoom-out">Уменьшить</button>
        <button id="download-pdf">Скачать PDF</button>
      </div>
      <div class="preview-container">
        <div id="pdf-preview">
          <!-- Здесь будет предпросмотр PDF -->
        </div>
      </div>
    </div>
  </main>
  
  <!-- Модальное окно для умных макросов -->
  <div id="smart-macros-modal" class="modal">
    <div class="modal-content" style="width: 70%; max-width: 800px;">
      <span class="close">&times;</span>
      <h2>Умные макросы</h2>
      
      <p>Умные макросы автоматически преобразуют текстовые шаблоны в LaTeX команды при нажатии Tab.</p>
      
      <!-- Вкладки для категорий -->
      <div class="macro-tabs">
        <button class="macro-tab-btn active" data-tab="user-macros">Мои макросы</button>
        <button class="macro-tab-btn" data-tab="math-macros">Математика</button>
        <button class="macro-tab-btn" data-tab="structure-macros">Структура</button>
        <button class="macro-tab-btn" data-tab="text-macros">Форматирование</button>
        <button class="macro-tab-btn" data-tab="env-macros">Окружения</button>
        <button class="macro-tab-btn" data-tab="create-macro">Создать</button>
      </div>
      
      <!-- Пользовательские макросы -->
      <div class="macro-tab-content" id="user-macros">
        <h3>Ваши пользовательские макросы</h3>
        <div id="smart-macros-list" class="macros-list">
          <!-- Здесь будет список пользовательских макросов -->
        </div>
        <p class="empty-list-message" id="empty-user-macros">У вас пока нет пользовательских макросов. Перейдите на вкладку "Создать" чтобы добавить макрос.</p>
      </div>
      
      <!-- Математические макросы -->
      <div class="macro-tab-content" id="math-macros" style="display: none;">
        <h3>Математические макросы</h3>
        <div class="macros-list predefined-macros">
          <div class="macro-item">
            <div class="macro-info">
              <div class="macro-pattern">a/b</div>
              <div class="macro-arrow">→</div>
              <div class="macro-result">\frac{a}{b}</div>
            </div>
            <button class="add-predefined-macro" data-pattern="([^\\s/]+)/([^\\s/]+)" data-template="\frac{$1}{$2}">Добавить</button>
          </div>
          <div class="macro-item">
            <div class="macro-info">
              <div class="macro-pattern">a^b</div>
              <div class="macro-arrow">→</div>
              <div class="macro-result">a^{b}</div>
            </div>
            <button class="add-predefined-macro" data-pattern="([A-Za-z0-9]+)\^([A-Za-z0-9]+)" data-template="$1^{$2}">Добавить</button>
          </div>
          <!-- Остальные математические макросы -->
          <!-- ... -->
        </div>
      </div>
      
      <!-- Структурные макросы -->
      <div class="macro-tab-content" id="structure-macros" style="display: none;">
        <h3>Структурные макросы</h3>
        <div class="macros-list predefined-macros">
          <!-- Структурные макросы -->
          <!-- ... -->
        </div>
      </div>
      
      <!-- Форматирование текста -->
      <div class="macro-tab-content" id="text-macros" style="display: none;">
        <h3>Макросы форматирования текста</h3>
        <div class="macros-list predefined-macros">
          <!-- Макросы форматирования -->
          <!-- ... -->
        </div>
      </div>
      
      <!-- Окружения -->
      <div class="macro-tab-content" id="env-macros" style="display: none;">
        <h3>Макросы окружений</h3>
        <div class="macros-list predefined-macros">
          <!-- Макросы окружений -->
          <!-- ... -->
        </div>
      </div>
      
      <!-- Создание пользовательского макроса -->
      <div class="macro-tab-content" id="create-macro" style="display: none;">
        <h3>Создать свой макрос</h3>
        <div class="form-group">
          <label for="smart-macro-pattern">Шаблон поиска:</label>
          <input type="text" id="smart-macro-pattern" placeholder="Например: ([^\\s/]+)/([^\\s/]+)">
          <p class="form-hint">Используйте регулярные выражения для определения шаблона.</p>
        </div>
        
        <div class="form-group">
          <label for="smart-macro-template">Шаблон замены:</label>
          <input type="text" id="smart-macro-template" placeholder="Например: \frac{$1}{$2}">
          <p class="form-hint">$1, $2, и т.д. будут заменены на соответствующие части шаблона.</p>
        </div>
        
        <div class="smart-macro-preview">
          <span class="smart-macro-preview-before" id="smart-macro-before">a1/b1</span>
          <span class="smart-macro-preview-arrow">→</span>
          <span class="smart-macro-preview-after" id="smart-macro-after">\frac{a1}{b1}</span>
        </div>
        
        <button id="add-smart-macro-btn" class="primary-btn">Добавить умный макрос</button>
      </div>
    </div>
  </div>
  
  <!-- Модальное окно для настроек -->
  <div id="settings-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Настройки</h2>
      
      <div class="settings-group">
        <h3>Компиляция и сохранение</h3>
        
        <div class="settings-row">
          <label class="switch">
            <input type="checkbox" id="autocompile-toggle">
            <span class="slider"></span>
          </label>
          <label for="autocompile-toggle">Автоматическая компиляция</label>
        </div>
        
        <div class="settings-row">
          <label for="autocompile-delay">Задержка автокомпиляции:</label>
          <input type="number" id="autocompile-delay" min="1" max="10" value="2" style="width: 60px; margin-left: 10px;"> сек.
        </div>
        
        <div class="settings-row">
          <label class="switch">
            <input type="checkbox" id="autosave-toggle" checked>
            <span class="slider"></span>
          </label>
          <label for="autosave-toggle">Автосохранение</label>
        </div>
        
        <div class="settings-row">
          <label for="autosave-interval">Интервал автосохранения:</label>
          <input type="number" id="autosave-interval" min="1" max="30" value="3" style="width: 60px; margin-left: 10px;"> сек.
        </div>
      </div>
      
      <div class="settings-group">
        <h3>Интерфейс</h3>
        
        <div class="settings-row">
          <label for="font-size">Размер шрифта в редакторе:</label>
          <select id="font-size" style="width: 100px; margin-left: 10px;">
            <option value="12">12px</option>
            <option value="14" selected>14px</option>
            <option value="16">16px</option>
            <option value="18">18px</option>
          </select>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Модальное окно для файлов -->
  <div id="files-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Управление файлами</h2>
      
      <div class="form-group">
        <label for="new-file-name">Новый файл:</label>
        <div style="display: flex; gap: 10px;">
          <input type="text" id="new-file-name" placeholder="Имя файла (без расширения)">
          <button id="create-file-btn">Создать</button>
        </div>
      </div>
      
      <h3 style="margin-top: 15px;">Ваши файлы</h3>
      <div id="file-list" class="file-list">
        <!-- Здесь будет список файлов -->
      </div>
    </div>
  </div>

  <!-- Модальное окно для редактора рисования -->
  <div id="drawing-modal" class="modal">
    <div class="modal-content drawing-modal-content">
      <span class="close">&times;</span>
      <h2>Редактор рисования</h2>
      
      <div class="drawing-toolbar">
        <div class="drawing-tools-group">
          <button class="drawing-tool active" data-tool="freehand" title="Свободное рисование">
            <svg viewBox="0 0 24 24" width="24" height="24">
              <path d="M3,17.25V21h3.75L17.81,9.94l-3.75-3.75L3,17.25z M20.71,7.04c0.39-0.39,0.39-1.02,0-1.41l-2.34-2.34c-0.39-0.39-1.02-0.39-1.41,0l-1.83,1.83l3.75,3.75L20.71,7.04z"/>
            </svg>
          </button>
          <button class="drawing-tool" data-tool="line" title="Линия">
            <svg viewBox="0 0 24 24" width="24" height="24">
              <path d="M19,13H5v-2h14V13z"/>
            </svg>
          </button>
          <button class="drawing-tool" data-tool="arrow" title="Стрелка">
            <svg viewBox="0 0 24 24" width="24" height="24">
              <path d="M8,5v14l11-7L8,5z"/>
            </svg>
          </button>
          <button class="drawing-tool" data-tool="rectangle" title="Прямоугольник">
            <svg viewBox="0 0 24 24" width="24" height="24">
              <path d="M19,3H5C3.9,3,3,3.9,3,5v14c0,1.1,0.9,2,2,2h14c1.1,0,2-0.9,2-2V5C21,3.9,20.1,3,19,3z M19,19H5V5h14V19z"/>
            </svg>
          </button>
          <button class="drawing-tool" data-tool="ellipse" title="Эллипс">
            <svg viewBox="0 0 24 24" width="24" height="24">
              <path d="M12,2C6.47,2,2,6.47,2,12s4.47,10,10,10s10-4.47,10-10S17.53,2,12,2z M12,20c-4.41,0-8-3.59-8-8s3.59-8,8-8s8,3.59,8,8S16.41,20,12,20z"/>
            </svg>
          </button>
          <button class="drawing-tool" data-tool="text" title="Текст">
            <svg viewBox="0 0 24 24" width="24" height="24">
              <path d="M5,17v2h14v-2H5z M9.5,12.8h5l0.9,2.2h2.1L12.75,4h-1.5L6.5,15h2.1L9.5,12.8z M12,5.98L13.87,11h-3.74L12,5.98z"/>
            </svg>
          </button>
        </div>
        
        <div class="drawing-settings-group">
          <div class="tool-option" id="color-option">
            <label for="drawing-color">Цвет:</label>
            <input type="color" id="drawing-color" value="#000000">
          </div>
          
          <div class="tool-option" id="line-width-option">
            <label for="drawing-line-width">Толщина: <span id="line-width-value">2</span>px</label>
            <input type="range" id="drawing-line-width" min="1" max="20" value="2">
          </div>
          
          <div class="tool-option" id="fill-option" style="display: none;">
            <label>
              <input type="checkbox" id="drawing-fill-enabled">
              Заливка
            </label>
            <input type="color" id="drawing-fill" value="#ffffff" disabled>
          </div>
          
          <div class="tool-option" id="font-option" style="display: none;">
            <label for="drawing-font-size">Размер: <span id="font-size-value">16</span>px</label>
            <input type="range" id="drawing-font-size" min="8" max="48" value="16">
          </div>
          
          <button id="drawing-clear" class="secondary-btn" title="Очистить холст">
            <svg viewBox="0 0 24 24" width="16" height="16">
              <path d="M19,4h-3.5l-1-1h-5l-1,1H5v2h14V4z M6,19c0,1.1,0.9,2,2,2h8c1.1,0,2-0.9,2-2V7H6V19z M8,9h8v10H8V9z"/>
            </svg>
            Очистить
          </button>
        </div>
      </div>
      
      <div id="drawing-canvas-container" class="drawing-canvas-container">
        <canvas id="drawing-canvas"></canvas>
      </div>
      
      <div class="drawing-actions">
        <button id="drawing-cancel" class="secondary-btn">Отмена</button>
        <button id="drawing-insert" class="primary-btn">Вставить в документ</button>
      </div>
    </div>
  </div>

  <!-- Исправленная структура загрузки JS файлов -->
  <!-- Сначала загрузим базовые модули -->
  <script>
    // Базовые переменные которые нужны для старта
    let editor;
    let currentFileName = 'document1.tex';
    let settings = {
      autoCompileEnabled: false,
      autoSaveEnabled: true,
      autoCompileDelay: 2,
      autoSaveInterval: 3,
      fontSize: 14
    };
    let smartMacros = [
      {
        pattern: '([^\\s/]+)/([^\\s/]+)',
        template: '\\frac{$1}{$2}'
      }
    ];
    let drawingEditor;
    
    // Инициализация редактора CodeMirror
    document.addEventListener('DOMContentLoaded', function() {
      // Инициализируем редактор
      editor = CodeMirror.fromTextArea(document.getElementById('editor'), {
        mode: "stex",
        lineNumbers: true,
        lineWrapping: true,
        indentUnit: 2,
        tabSize: 2,
        autofocus: true,
        matchBrackets: true,
        autoCloseBrackets: true,
        extraKeys: {
          "Ctrl-Enter": function() { compileLatex(); },
          "Tab": function(cm) {
            // Вставляем обычный таб, т.к. умные макросы еще не инициализированы
            cm.replaceSelection("  ");
          }
        }
      });
      
      // Отображаем курсор
      editor.on("cursorActivity", function() {
        const cursor = editor.getCursor();
        document.getElementById('cursor-position').textContent = `Строка: ${cursor.line + 1}, Столбец: ${cursor.ch + 1}`;
      });
      
      // Настраиваем основные обработчики событий
      setupBasicEventHandlers();
      
      // Компилируем при первой загрузке
      setTimeout(compileLatex, 500);
    });
    
    // Настройка базовых обработчиков событий
    function setupBasicEventHandlers() {
      // Кнопка компиляции
      document.getElementById('compile-btn').addEventListener('click', function() {
        compileLatex();
      });
      
      // Кнопки зума
      document.getElementById('zoom-in').addEventListener('click', function() {
        const preview = document.getElementById('pdf-preview');
        const currentScale = parseFloat(preview.style.transform.replace('scale(', '').replace(')', '') || 1);
        preview.style.transform = `scale(${currentScale + 0.1})`;
      });
      
      document.getElementById('zoom-out').addEventListener('click', function() {
        const preview = document.getElementById('pdf-preview');
        const currentScale = parseFloat(preview.style.transform.replace('scale(', '').replace(')', '') || 1);
        if (currentScale > 0.5) {
          preview.style.transform = `scale(${currentScale - 0.1})`;
        }
      });
      
      // Кнопка скачивания PDF
      document.getElementById('download-pdf').addEventListener('click', function() {
        alert('PDF файл успешно скомпилирован и готов к скачиванию.\nВ реальном приложении здесь будет загрузка настоящего PDF файла.');
      });
      
      // Кнопка справки
      document.getElementById('help-btn').addEventListener('click', function() {
        alert('Справка по LaTeX:\n\n' + 
          '- Используйте кнопки панели инструментов для вставки типовых элементов\n' +
          '- Нажмите Tab после ввода выражения вида a/b для автоматического преобразования в дробь\n' +
          '- Создавайте собственные умные макросы через меню "Умные макросы"\n' +
          '- В меню "Умные макросы" доступны категории: Математика, Структура, Форматирование и Окружения\n' +
          '- Управляйте файлами через меню "Файлы"\n' +
          '- Настраивайте автокомпиляцию и автосохранение в настройках\n' +
          '- Нажмите Ctrl+Enter для компиляции документа');
      });
      
      // Кнопки панели инструментов
      document.querySelectorAll('.toolbar button[data-insert]').forEach(button => {
        button.addEventListener('click', function() {
          const template = this.getAttribute('data-insert');
          const cursor = editor.getCursor();
          editor.replaceRange(template, cursor);
          editor.focus();
        });
      });
      
      // Модальные окна - открытие и закрытие
      document.querySelectorAll('.modal .close').forEach(function(closeBtn) {
        closeBtn.addEventListener('click', function() {
          this.closest('.modal').style.display = 'none';
        });
      });
      
      window.addEventListener('click', function(event) {
        document.querySelectorAll('.modal').forEach(modal => {
          if (event.target === modal) {
            modal.style.display = 'none';
          }
        });
      });
      
      // Открытие модальных окон
      document.getElementById('settings-btn').addEventListener('click', function() {
        document.getElementById('settings-modal').style.display = 'block';
      });
      
      document.getElementById('files-btn').addEventListener('click', function() {
        document.getElementById('files-modal').style.display = 'block';
        loadFilesList();
      });
      
      document.getElementById('smart-macros-btn').addEventListener('click', function() {
        document.getElementById('smart-macros-modal').style.display = 'block';
      });
      
      // Обработчик для редактора рисования
      document.getElementById('drawing-btn').addEventListener('click', function() {
        alert('Редактор рисования загружается...');
        // В полной версии здесь будет открытие редактора рисования
      });
    }
    
    // Функция для компиляции LaTeX
    function compileLatex() {
      const latexCode = editor.getValue();
      
      // Показываем индикатор загрузки
      const loadingOverlay = document.querySelector('.loading-overlay');
      const statusElement = document.getElementById('status');
      
      if (loadingOverlay) {
        loadingOverlay.style.display = 'flex';
      }
      
      if (statusElement) {
        statusElement.textContent = "Компиляция...";
      }
      
      // Имитация процесса компиляции с задержкой (для демонстрации)
      setTimeout(() => {
        try {
          // Парсинг LaTeX кода и отображение
          const preview = document.getElementById('pdf-preview');
          
          // Извлечение заголовка
          const titleMatch = latexCode.match(/\\title\{([^}]*)\}/);
          const title = titleMatch ? titleMatch[1] : "Без названия";
          
          // Извлечение автора
          const authorMatch = latexCode.match(/\\author\{([^}]*)\}/);
          const author = authorMatch ? authorMatch[1] : "";
          
          // Извлечение даты
          const dateMatch = latexCode.match(/\\date\{([^}]*)\}/);
          let date = dateMatch ? dateMatch[1] : "\\today";
          if (date === "\\today") {
            const today = new Date();
            date = today.toLocaleDateString('ru-RU');
          }
          
          // Извлечение секций
          const sections = [];
          const sectionRegex = /\\section\{([^}]*)\}([\s\S]*?)(?=\\section\{|\\end\{document\})/g;
          let sectionMatch;
          let content = latexCode;
          while ((sectionMatch = sectionRegex.exec(content)) !== null) {
            sections.push({
              title: sectionMatch[1],
              content: sectionMatch[2]
            });
          }
          
          // Создаем HTML для предпросмотра
          let html = `
            <div class="pdf-title">${title}</div>
            <div class="pdf-author">${author}</div>
            <div class="pdf-date">${date}</div>
          `;
          
          // Добавляем секции
          if (sections.length > 0) {
            sections.forEach(section => {
              html += `<div class="pdf-section">${section.title}</div>`;
              
              // Обработка списков и других элементов
              let sectionContent = section.content;
              
              // Обработка списков itemize
              sectionContent = sectionContent.replace(/\\begin\{itemize\}([\s\S]*?)\\end\{itemize\}/g, function(match, listContent) {
                let listHTML = '<ul class="pdf-list">';
                const itemRegex = /\\item\s+(.*?)(?=\\item|$)/gs;
                let itemMatch;
                while ((itemMatch = itemRegex.exec(listContent)) !== null) {
                  listHTML += `<li>${itemMatch[1].trim()}</li>`;
                }
                listHTML += '</ul>';
                return listHTML;
              });
              
              // Разбиение на абзацы
              const paragraphs = sectionContent.split('\n\n');
              paragraphs.forEach(paragraph => {
                if (paragraph.trim() && !paragraph.includes('<ul') && !paragraph.includes('<ol')) {
                  html += `<div class="pdf-paragraph">${paragraph.trim()}</div>`;
                } else {
                  html += paragraph;
                }
              });
            });
          }
          
          // Обновляем предпросмотр
          preview.innerHTML = html;
          
          // Запускаем MathJax для рендеринга формул если он доступен
          if (typeof MathJax !== 'undefined') {
            MathJax.typesetPromise([preview]).catch(function (err) {
              console.error('MathJax ошибка:', err);
            });
          }
          
          if (statusElement) {
            statusElement.textContent = "Компиляция завершена";
            setTimeout(() => {
              statusElement.textContent = "Готово";
            }, 2000);
          }
        } catch (error) {
          console.error("Ошибка компиляции:", error);
          if (statusElement) {
            statusElement.textContent = "Ошибка компиляции: " + error.message;
          }
        } finally {
          if (loadingOverlay) {
            loadingOverlay.style.display = 'none';
          }
        }
      }, 800);
    }
    
    // Функция для загрузки списка файлов
    function loadFilesList() {
      const fileList = document.getElementById('file-list');
      fileList.innerHTML = '';
      
      // Получаем список файлов из localStorage
      const fileKeys = Object.keys(localStorage).filter(key => key.startsWith('latex-document-'));
      
      // Если нет файлов, создаем первый файл
      if (fileKeys.length === 0) {
        localStorage.setItem('latex-document-' + currentFileName, editor.getValue());
        fileKeys.push('latex-document-' + currentFileName);
      }
      
      // Отображаем файлы
      fileKeys.forEach(key => {
        const fileName = key.replace('latex-document-', '');
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        
        if (fileName === currentFileName) {
          fileItem.classList.add('active');
        }
        
        fileItem.innerHTML = `
          <div>${fileName}</div>
          <div class="file-actions">
            <button class="rename-file" data-name="${fileName}">Переименовать</button>
            <button class="delete-file" data-name="${fileName}">Удалить</button>
          </div>
        `;
        
        // При клике на элемент загружаем файл
        fileItem.addEventListener('click', function(e) {
          // Игнорируем клики на кнопках
          if (e.target.tagName === 'BUTTON') return;
          
          if (fileName !== currentFileName) {
            loadFile(fileName);
          }
        });
        
        fileList.appendChild(fileItem);
      });
      
      // Добавляем обработчики для кнопок
      document.querySelectorAll('.rename-file').forEach(btn => {
        btn.addEventListener('click', function() {
          const oldName = this.getAttribute('data-name');
          const newName = prompt('Введите новое имя файла:', oldName);
          
          if (newName && newName.trim() && newName !== oldName) {
            renameFile(oldName, newName);
          }
        });
      });
      
      document.querySelectorAll('.delete-file').forEach(btn => {
        btn.addEventListener('click', function() {
          const fileName = this.getAttribute('data-name');
          
          if (confirm(`Вы уверены, что хотите удалить файл "${fileName}"?`)) {
            deleteFile(fileName);
          }
        });
      });
      
      // Кнопка создания нового файла
      document.getElementById('create-file-btn').addEventListener('click', function() {
        const fileName = document.getElementById('new-file-name').value.trim();
        if (fileName) {
          createNewFile(fileName);
          document.getElementById('new-file-name').value = '';
        } else {
          alert('Введите имя файла!');
        }
      });
    }
    
    // Функция загрузки файла
    function loadFile(fileName) {
      // Сохраняем текущий файл перед переключением
      if (currentFileName) {
        localStorage.setItem('latex-document-' + currentFileName, editor.getValue());
      }
      
      // Загружаем выбранный файл
      const fileContent = localStorage.getItem('latex-document-' + fileName);
      if (fileContent) {
        editor.setValue(fileContent);
        currentFileName = fileName;
        document.getElementById('current-file').textContent = fileName;
        
        // Закрываем модальное окно
        document.getElementById('files-modal').style.display = 'none';
        
        // Компилируем загруженный файл
        compileLatex();
      }
    }
    
    // Функция для создания нового файла
    function createNewFile(fileName) {
      if (!fileName.trim()) {
        alert('Имя файла не может быть пустым');
        return;
      }
      
      // Добавляем расширение .tex, если его нет
      if (!fileName.endsWith('.tex')) {
        fileName += '.tex';
      }
      
      // Проверяем существование файла
      if (localStorage.getItem('latex-document-' + fileName)) {
        alert(`Файл с именем "${fileName}" уже существует!`);
        return;
      }
      
      // Сохраняем текущий файл
      localStorage.setItem('latex-document-' + currentFileName, editor.getValue());
      
      // Создаем шаблон для нового файла
      const templateContent = `\\documentclass{article}
\\usepackage[utf8]{inputenc}
\\usepackage[T2A]{fontenc}
\\usepackage[russian]{babel}
\\usepackage{amsmath}
\\usepackage{amsfonts}
\\usepackage{amssymb}
\\usepackage{graphicx}
\\usepackage{hyperref}

\\title{${fileName.replace('.tex', '')}}
\\author{Автор}
\\date{\\today}

\\begin{document}

\\maketitle

\\section{Введение}
Содержимое нового файла.

\\end{document}`;
      
      // Сохраняем новый файл
      localStorage.setItem('latex-document-' + fileName, templateContent);
      
      // Загружаем новый файл в редактор
      loadFile(fileName);
      
      // Обновляем список файлов
      loadFilesList();
    }
    
    // Функция переименования файла
    function renameFile(oldName, newName) {
      // Добавляем расширение .tex, если его нет
      if (!newName.endsWith('.tex')) {
        newName += '.tex';
      }
      
      // Проверяем существование файла с новым именем
      if (localStorage.getItem('latex-document-' + newName)) {
        alert(`Файл с именем "${newName}" уже существует!`);
        return;
      }
      
      // Копируем содержимое
      const content = localStorage.getItem('latex-document-' + oldName);
      localStorage.setItem('latex-document-' + newName, content);
      
      // Удаляем старый файл
      localStorage.removeItem('latex-document-' + oldName);
      
      // Если переименовываем текущий файл, обновляем currentFileName
      if (oldName === currentFileName) {
        currentFileName = newName;
        document.getElementById('current-file').textContent = newName;
      }
      
      // Обновляем список файлов
      loadFilesList();
    }
    
    // Функция удаления файла
    function deleteFile(fileName) {
      localStorage.removeItem('latex-document-' + fileName);
      
      // Если удаляем текущий файл, загружаем другой
      if (fileName === currentFileName) {
        const fileKeys = Object.keys(localStorage).filter(key => key.startsWith('latex-document-'));
        
        if (fileKeys.length > 0) {
          // Загружаем первый оставшийся файл
          loadFile(fileKeys[0].replace('latex-document-', ''));
        } else {
          // Если файлов не осталось, создаем новый
          const newFileName = 'document1.tex';
          currentFileName = newFileName;
          document.getElementById('current-file').textContent = newFileName;
          
          // Сбрасываем редактор к шаблону
          editor.setValue(`\\documentclass{article}
\\usepackage[utf8]{inputenc}
\\usepackage[T2A]{fontenc}
\\usepackage[russian]{babel}
\\usepackage{amsmath}
\\usepackage{amsfonts}
\\usepackage{amssymb}
\\usepackage{graphicx}
\\usepackage{hyperref}

\\title{Новый документ}
\\author{Автор}
\\date{\\today}

\\begin{document}

\\maketitle

\\section{Введение}
Содержимое нового документа.

\\end{document}`);
          
          // Сохраняем новый файл
          localStorage.setItem('latex-document-' + newFileName, editor.getValue());
        }
      }
      
      // Обновляем список файлов
      loadFilesList();
    }
