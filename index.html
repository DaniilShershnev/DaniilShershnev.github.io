// Модальные окна - открытие и закрытие
      document.querySelectorAll('.modal .close').forEach(function(closeBtn) {
        closeBtn.addEventListener('click', function() {
          this.closest('.modal').style.display = 'none';
        });
      });
      
      window.addEventListener('click', function(event) {
        document.querySelectorAll('.modal').forEach(modal => {
          if (event.target === modal) {
            modal.style.display = 'none';
          }
        });
      });
      
      // Открытие модальных окон
      document.getElementById('settings-btn').addEventListener('click', function() {
        document.getElementById('settings-modal').style.display = 'block';
      });
      
      document.getElementById('files-btn').addEventListener('click', function() {
        document.getElementById('files-modal').style.display = 'block';
        loadFilesList();
      });
      
      document.getElementById('smart-macros-btn').addEventListener('click', function() {
        document.getElementById('smart-macros-modal').style.display = 'block';
      });
      
      // Обработчик для редактора рисования
      document.getElementById('drawing-btn').addEventListener('click', function() {
        alert('Редактор рисования загружается...');
        // В полной версии здесь будет открытие редактора рисования
      });
    }
    
    // Функция для компиляции LaTeX
    function compileLatex() {
      const latexCode = editor.getValue();
      
      // Показываем индикатор загрузки
      const loadingOverlay = document.querySelector('.loading-overlay');
      const statusElement = document.getElementById('status');
      
      if (loadingOverlay) {
        loadingOverlay.style.display = 'flex';
      }
      
      if (statusElement) {
        statusElement.textContent = "Компиляция...";
      }
      
      // Имитация процесса компиляции с задержкой (для демонстрации)
      setTimeout(() => {
        try {
          // Парсинг LaTeX кода и отображение
          const preview = document.getElementById('pdf-preview');
          
          // Извлечение заголовка
          const titleMatch = latexCode.match(/\\title\{([^}]*)\}/);
          const title = titleMatch ? titleMatch[1] : "Без названия";
          
          // Извлечение автора
          const authorMatch = latexCode.match(/\\author\{([^}]*)\}/);
          const author = authorMatch ? authorMatch[1] : "";
          
          // Извлечение даты
          const dateMatch = latexCode.match(/\\date\{([^}]*)\}/);
          let date = dateMatch ? dateMatch[1] : "\\today";
          if (date === "\\today") {
            const today = new Date();
            date = today.toLocaleDateString('ru-RU');
          }
          
          // Извлечение секций
          const sections = [];
          const sectionRegex = /\\section\{([^}]*)\}([\s\S]*?)(?=\\section\{|\\end\{document\})/g;
          let sectionMatch;
          let content = latexCode;
          while ((sectionMatch = sectionRegex.exec(content)) !== null) {
            sections.push({
              title: sectionMatch[1],
              content: sectionMatch[2]
            });
          }
          
          // Создаем HTML для предпросмотра
          let html = `
            <div class="pdf-title">${title}</div>
            <div class="pdf-author">${author}</div>
            <div class="pdf-date">${date}</div>
          `;
          
          // Добавляем секции
          if (sections.length > 0) {
            sections.forEach(section => {
              html += `<div class="pdf-section">${section.title}</div>`;
              
              // Обработка списков и других элементов
              let sectionContent = section.content;
              
              // Обработка списков itemize
              sectionContent = sectionContent.replace(/\\begin\{itemize\}([\s\S]*?)\\end\{itemize\}/g, function(match, listContent) {
                let listHTML = '<ul class="pdf-list">';
                const itemRegex = /\\item\s+(.*?)(?=\\item|$)/gs;
                let itemMatch;
                while ((itemMatch = itemRegex.exec(listContent)) !== null) {
                  listHTML += `<li>${itemMatch[1].trim()}</li>`;
                }
                listHTML += '</ul>';
                return listHTML;
              });
              
              // Разбиение на абзацы
              const paragraphs = sectionContent.split('\n\n');
              paragraphs.forEach(paragraph => {
                if (paragraph.trim() && !paragraph.includes('<ul') && !paragraph.includes('<ol')) {
                  html += `<div class="pdf-paragraph">${paragraph.trim()}</div>`;
                } else {
                  html += paragraph;
                }
              });
            });
          }
          
          // Обновляем предпросмотр
          preview.innerHTML = html;
          
          // Запускаем MathJax для рендеринга формул если он доступен
          if (typeof MathJax !== 'undefined') {
            MathJax.typesetPromise([preview]).catch(function (err) {
              console.error('MathJax ошибка:', err);
            });
          }
          
          if (statusElement) {
            statusElement.textContent = "Компиляция завершена";
            setTimeout(() => {
              statusElement.textContent = "Готово";
            }, 2000);
          }
        } catch (error) {
          console.error("Ошибка компиляции:", error);
          if (statusElement) {
            statusElement.textContent = "Ошибка компиляции: " + error.message;
          }
        } finally {
          if (loadingOverlay) {
            loadingOverlay.style.display = 'none';
          }
        }
      }, 800);
    }
    
    // Функция для загрузки списка файлов
    function loadFilesList() {
      const fileList = document.getElementById('file-list');
      fileList.innerHTML = '';
      
      // Получаем список файлов из localStorage
      const fileKeys = Object.keys(localStorage).filter(key => key.startsWith('latex-document-'));
      
      // Если нет файлов, создаем первый файл
      if (fileKeys.length === 0) {
        localStorage.setItem('latex-document-' + currentFileName, editor.getValue());
        fileKeys.push('latex-document-' + currentFileName);
      }
      
      // Отображаем файлы
      fileKeys.forEach(key => {
        const fileName = key.replace('latex-document-', '');
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        
        if (fileName === currentFileName) {
          fileItem.classList.add('active');
        }
        
        fileItem.innerHTML = `
          <div>${fileName}</div>
          <div class="file-actions">
            <button class="rename-file" data-name="${fileName}">Переименовать</button>
            <button class="delete-file" data-name="${fileName}">Удалить</button>
          </div>
        `;
        
        // При клике на элемент загружаем файл
        fileItem.addEventListener('click', function(e) {
          // Игнорируем клики на кнопках
          if (e.target.tagName === 'BUTTON') return;
          
          if (fileName !== currentFileName) {
            loadFile(fileName);
          }
        });
        
        fileList.appendChild(fileItem);
      });
      
      // Добавляем обработчики для кнопок
      document.querySelectorAll('.rename-file').forEach(btn => {
        btn.addEventListener('click', function() {
          const oldName = this.getAttribute('data-name');
          const newName = prompt('Введите новое имя файла:', oldName);
          
          if (newName && newName.trim() && newName !== oldName) {
            renameFile(oldName, newName);
          }
        });
      });
      
      document.querySelectorAll('.delete-file').forEach(btn => {
        btn.addEventListener('click', function() {
          const fileName = this.getAttribute('data-name');
          
          if (confirm(`Вы уверены, что хотите удалить файл "${fileName}"?`)) {
            deleteFile(fileName);
          }
        });
      });
      
      // Кнопка создания нового файла
      document.getElementById('create-file-btn').addEventListener('click', function() {
        const fileName = document.getElementById('new-file-name').value.trim();
        if (fileName) {
          createNewFile(fileName);
          document.getElementById('new-file-name').value = '';
        } else {
          alert('Введите имя файла!');
        }
      });
    }
    
    // Функция загрузки файла
    function loadFile(fileName) {
      // Сохраняем текущий файл перед переключением
      if (currentFileName) {
        localStorage.setItem('latex-document-' + currentFileName, editor.getValue());
      }
      
      // Загружаем выбранный файл
      const fileContent = localStorage.getItem('latex-document-' + fileName);
      if (fileContent) {
        editor.setValue(fileContent);
        currentFileName = fileName;
        document.getElementById('current-file').textContent = fileName;
        
        // Закрываем модальное окно
        document.getElementById('files-modal').style.display = 'none';
        
        // Компилируем загруженный файл
        compileLatex();
      }
    }
    
    // Функция для создания нового файла
    function createNewFile(fileName) {
      if (!fileName.trim()) {
        alert('Имя файла не может быть пустым');
        return;
      }
      
      // Добавляем расширение .tex, если его нет
      if (!fileName.endsWith('.tex')) {
        fileName += '.tex';
      }
      
      // Проверяем существование файла
      if (localStorage.getItem('latex-document-' + fileName)) {
        alert(`Файл с именем "${fileName}" уже существует!`);
        return;
      }
      
      // Сохраняем текущий файл
      localStorage.setItem('latex-document-' + currentFileName, editor.getValue());
      
      // Создаем шаблон для нового файла
      const templateContent = `\\documentclass{article}
\\usepackage[utf8]{inputenc}
\\usepackage[T2A]{fontenc}
\\usepackage[russian]{babel}
\\usepackage{amsmath}
\\usepackage{amsfonts}
\\usepackage{amssymb}
\\usepackage{graphicx}
\\usepackage{hyperref}

\\title{${fileName.replace('.tex', '')}}
\\author{Автор}
\\date{\\today}

\\begin{document}

\\maketitle

\\section{Введение}
Содержимое нового файла.

\\end{document}`;
      
      // Сохраняем новый файл
      localStorage.setItem('latex-document-' + fileName, templateContent);
      
      // Загружаем новый файл в редактор
      loadFile(fileName);
      
      // Обновляем список файлов
      loadFilesList();
    }
    
    // Функция переименования файла
    function renameFile(oldName, newName) {
      // Добавляем расширение .tex, если его нет
      if (!newName.endsWith('.tex')) {
        newName += '.tex';
      }
      
      // Проверяем существование файла с новым именем
      if (localStorage.getItem('latex-document-' + newName)) {
        alert(`Файл с именем "${newName}" уже существует!`);
        return;
      }
      
      // Копируем содержимое
      const content = localStorage.getItem('latex-document-' + oldName);
      localStorage.setItem('latex-document-' + newName, content);
      
      // Удаляем старый файл
      localStorage.removeItem('latex-document-' + oldName);
      
      // Если переименовываем текущий файл, обновляем currentFileName
      if (oldName === currentFileName) {
        currentFileName = newName;
        document.getElementById('current-file').textContent = newName;
      }
      
      // Обновляем список файлов
      loadFilesList();
    }
    
    // Функция удаления файла
    function deleteFile(fileName) {
      localStorage.removeItem('latex-document-' + fileName);
      
      // Если удаляем текущий файл, загружаем другой
      if (fileName === currentFileName) {
        const fileKeys = Object.keys(localStorage).filter(key => key.startsWith('latex-document-'));
        
        if (fileKeys.length > 0) {
          // Загружаем первый оставшийся файл
          loadFile(fileKeys[0].replace('latex-document-', ''));
        } else {
          // Если файлов не осталось, создаем новый
          const newFileName = 'document1.tex';
          currentFileName = newFileName;
          document.getElementById('current-file').textContent = newFileName;
          
          // Сбрасываем редактор к шаблону
          editor.setValue(`\\documentclass{article}
\\usepackage[utf8]{inputenc}
\\usepackage[T2A]{fontenc}
\\usepackage[russian]{babel}
\\usepackage{amsmath}
\\usepackage{amsfonts}
\\usepackage{amssymb}
\\usepackage{graphicx}
\\usepackage{hyperref}

\\title{Новый документ}
\\author{Автор}
\\date{\\today}

\\begin{document}

\\maketitle

\\section{Введение}
Содержимое нового документа.

\\end{document}`);
          
          // Сохраняем новый файл
          localStorage.setItem('latex-document-' + newFileName, editor.getValue());
        }
      }
      
      // Обновляем список файлов
      loadFilesList();
    }
    
    // Функция обновления статуса
    function updateStatus(message, timeout = 2000) {
      const statusElement = document.getElementById('status');
      
      if (statusElement) {
        statusElement.textContent = message;
        
        if (timeout) {
          setTimeout(() => {
            statusElement.textContent = "Готово";
          }, timeout);
        }
      }
    }
    
    // Функция парсинга LaTeX документа
    function parseLatexDocument(latexCode) {
      const document = {};
      
      // Извлечение заголовка
      const titleMatch = latexCode.match(/\\title\{([^}]*)\}/);
      document.title = titleMatch ? titleMatch[1] : "Без названия";
      
      // Извлечение автора
      const authorMatch = latexCode.match(/\\author\{([^}]*)\}/);
      document.author = authorMatch ? authorMatch[1] : "";
      
      // Извлечение даты
      const dateMatch = latexCode.match(/\\date\{([^}]*)\}/);
      document.date = dateMatch ? dateMatch[1] : "\\today";
      if (document.date === "\\today") {
        const today = new Date();
        document.date = today.toLocaleDateString('ru-RU');
      }
      
      // Извлечение содержимого документа
      const bodyMatch = latexCode.match(/\\begin\{document\}([\s\S]*)\\end\{document\}/);
      document.body = bodyMatch ? bodyMatch[1] : "";
      
      // Извлечение секций
      document.sections = [];
      const sectionRegex = /\\section\{([^}]*)\}([\s\S]*?)(?=\\section\{|\\end\{document\})/g;
      let sectionMatch;
      while ((sectionMatch = sectionRegex.exec(latexCode)) !== null) {
        document.sections.push({
          title: sectionMatch[1],
          content: sectionMatch[2]
        });
      }
      
      return document;
    }
  </script>
  
  <!-- Скрипт для загрузки изображений -->
  <script src="js/image-upload.js"></script>
</body>
</html>
